{#
 # Sender IDs Index - Using cp-table layout
 #
 # This template extends the base plugin's cp-table layout to provide
 # a consistent interface for viewing Sender IDs with grouped filters,
 # sorting, and bulk actions.
 #}

{% extends 'lindemannrock-base/_layouts/cp-table' %}

{# ============================================================================
   PERMISSION CHECKS
   ============================================================================ #}

{% set canCreate = currentUser.can('smsManager:createSenderIds') %}
{% set canEdit = currentUser.can('smsManager:editSenderIds') %}
{% set canDelete = currentUser.can('smsManager:deleteSenderIds') %}

{# ============================================================================
   GET QUERY PARAMETERS
   ============================================================================ #}

{% set search = craft.app.request.getParam('search', '') %}
{% set statusFilter = craft.app.request.getParam('status', 'all') %}
{% set sourceFilter = craft.app.request.getParam('source', 'all') %}
{% set providerFilter = craft.app.request.getParam('provider', 'all') %}
{% set testFilter = craft.app.request.getParam('test', 'all') %}
{% set sort = craft.app.request.getParam('sort', 'name') %}
{% set dir = craft.app.request.getParam('dir', 'asc') %}
{% set page = craft.app.request.getParam('page', 1)|number_format(0, '', '') %}
{% set limit = settings.itemsPerPage ?? 50 %}
{% set offset = (page - 1) * limit %}

{# ============================================================================
   FILTER SENDER IDS
   ============================================================================ #}

{% set filteredSenderIds = senderIds %}

{# Status filter #}
{% if statusFilter == 'enabled' %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => s.enabled) %}
{% elseif statusFilter == 'disabled' %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => not s.enabled) %}
{% endif %}

{# Source filter #}
{% if sourceFilter == 'config' %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => s.source == 'config') %}
{% elseif sourceFilter == 'database' %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => s.source != 'config') %}
{% endif %}

{# Provider filter #}
{% if providerFilter != 'all' %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => s.providerHandle == providerFilter) %}
{% endif %}

{# Type filter (Test/Production) #}
{% if testFilter == 'test' %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => s.isDev) %}
{% elseif testFilter == 'production' %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => not s.isDev) %}
{% endif %}

{# Search filter #}
{% if search %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => search|lower in s.name|lower or search|lower in s.handle|lower or search|lower in s.senderId|lower) %}
{% endif %}

{# Sort sender IDs #}
{% if sort == 'name' %}
    {% set filteredSenderIds = filteredSenderIds|sort((a, b) => dir == 'asc' ? a.name|lower <=> b.name|lower : b.name|lower <=> a.name|lower) %}
{% elseif sort == 'handle' %}
    {% set filteredSenderIds = filteredSenderIds|sort((a, b) => dir == 'asc' ? a.handle|lower <=> b.handle|lower : b.handle|lower <=> a.handle|lower) %}
{% elseif sort == 'senderId' %}
    {% set filteredSenderIds = filteredSenderIds|sort((a, b) => dir == 'asc' ? a.senderId|lower <=> b.senderId|lower : b.senderId|lower <=> a.senderId|lower) %}
{% elseif sort == 'provider' %}
    {% set filteredSenderIds = filteredSenderIds|sort((a, b) => dir == 'asc' ? (a.providerHandle ?? '')|lower <=> (b.providerHandle ?? '')|lower : (b.providerHandle ?? '')|lower <=> (a.providerHandle ?? '')|lower) %}
{% elseif sort == 'source' %}
    {% set filteredSenderIds = filteredSenderIds|sort((a, b) => dir == 'asc' ? (a.source ?? '') <=> (b.source ?? '') : (b.source ?? '') <=> (a.source ?? '')) %}
{% elseif sort == 'isDev' %}
    {% set filteredSenderIds = filteredSenderIds|sort((a, b) => dir == 'asc' ? a.isDev <=> b.isDev : b.isDev <=> a.isDev) %}
{% elseif sort == 'enabled' %}
    {% set filteredSenderIds = filteredSenderIds|sort((a, b) => dir == 'asc' ? a.enabled <=> b.enabled : b.enabled <=> a.enabled) %}
{% endif %}

{% set totalCount = filteredSenderIds|length %}
{% set paginatedSenderIds = filteredSenderIds|slice(offset, limit) %}


{# ============================================================================
   BUILD PROVIDER OPTIONS FOR FILTER
   ============================================================================ #}

{% set providerOptions = [{value: 'all', label: 'All Providers'|t('sms-manager'), status: 'all'}] %}
{% for provider in providers %}
    {% set providerOptions = providerOptions|merge([{
        value: provider.handle,
        label: provider.name,
        statusColor: '#6366f1',
    }]) %}
{% endfor %}


{# ============================================================================
   TABLE CONFIGURATION
   ============================================================================ #}

{% set tableConfig = {
    plugin: {
        handle: 'sms-manager',
        name: smsHelper.fullName,
    },
    page: {
        title: 'Sender IDs'|t('sms-manager'),
        subnav: 'sender-ids',
        crumbs: [
            { label: smsHelper.fullName, url: url('sms-manager') },
            { label: 'Sender IDs'|t('sms-manager'), url: url('sms-manager/sender-ids') }
        ],
    },
    filters: [
        {
            type: 'status',
            param: 'status',
            current: statusFilter,
            label: 'All'|t('sms-manager'),
            groups: [
                {
                    param: 'status',
                    current: statusFilter,
                    options: [
                        {value: 'all', label: 'All'|t('sms-manager'), status: 'all'},
                        {value: 'enabled', label: 'Enabled'|t('sms-manager'), status: 'green'},
                        {value: 'disabled', label: 'Disabled'|t('sms-manager'), status: 'disabled'},
                    ],
                },
                {
                    header: 'Config Source'|t('sms-manager'),
                    param: 'source',
                    current: sourceFilter,
                    colorSet: 'configSource',
                    options: [
                        {value: 'all', label: 'All Sources'|t('sms-manager'), status: 'all'},
                        {value: 'config', label: 'Config File'|t('sms-manager'), colorKey: 'config'},
                        {value: 'database', label: 'Database'|t('sms-manager'), colorKey: 'database'},
                    ],
                },
                {
                    header: 'Provider'|t('sms-manager'),
                    param: 'provider',
                    current: providerFilter,
                    options: providerOptions,
                },
                {
                    header: 'Type'|t('sms-manager'),
                    param: 'test',
                    current: testFilter,
                    colorSet: 'environmentType',
                    options: [
                        {value: 'all', label: 'All Types'|t('sms-manager'), status: 'all'},
                        {value: 'production', label: 'Production'|t('sms-manager'), colorKey: 'production'},
                        {value: 'test', label: 'Development'|t('sms-manager'), colorKey: 'development'},
                    ],
                },
            ],
        },
    ],
    search: {
        placeholder: 'Search sender IDs...'|t('sms-manager'),
        value: search,
    },
    sort: {
        field: sort,
        direction: dir,
    },
    table: {
        columns: [
            {key: 'name', label: 'Name'|t('sms-manager'), sortable: true},
            {key: 'handle', label: 'Handle'|t('sms-manager'), sortable: true},
            {key: 'senderId', label: 'Sender ID'|t('sms-manager'), sortable: true},
            {key: 'provider', label: 'Provider'|t('sms-manager'), sortable: true},
            {key: 'isDev', label: 'Type'|t('sms-manager'), sortable: true},
            {key: 'source', label: 'Source'|t('sms-manager'), sortable: true},
            {key: 'enabled', label: 'Status'|t('sms-manager'), sortable: true},
            {key: 'default', label: 'Default'|t('sms-manager')},
        ],
        items: paginatedSenderIds,
        emptyMessage: 'No sender IDs found.'|t('sms-manager'),
        hasConfigItems: true,
    },
    pagination: {
        page: page,
        limit: limit,
        totalCount: totalCount,
        itemLabel: {singular: 'sender ID'|t('sms-manager'), plural: 'sender IDs'|t('sms-manager')},
    },
    checkboxes: canEdit or canDelete,
    newButton: canCreate ? {
        url: url('sms-manager/sender-ids/new'),
        label: 'New Sender ID'|t('sms-manager'),
        permission: 'smsManager:createSenderIds',
    } : null,
} %}


{# ============================================================================
   BEFORE TABLE - Warning messages
   ============================================================================ #}

{% block beforeTable %}
    <style>
        .config-tooltip::before {
            content: 'config/sms-manager.php';
            display: block;
            color: #8f98a3;
            font-size: 10px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e3e5e8;
        }
    </style>

    {# Warning if default sender ID is missing or disabled #}
    {% if defaultSenderIdHandle %}
        {% set defaultSenderId = senderIds|filter(s => s.handle == defaultSenderIdHandle)|first %}
        {% if not defaultSenderId %}
            {% set warningMessage %}
            <strong>{{ 'Warning'|t('sms-manager') }}:</strong>
            {{ 'The default sender ID handle "{handle}" does not exist.'|t('sms-manager', {handle: defaultSenderIdHandle}) }}
            {% if isDefaultFromConfig %}
                {{ 'Update your config/sms-manager.php to point to a valid sender ID handle.'|t('sms-manager') }}
            {% else %}
                {{ 'Please set a different sender ID as default.'|t('sms-manager') }}
            {% endif %}
            {% endset %}
            <div class="info-box-table-wrapper">
                {% include 'lindemannrock-base/_components/info-box' with {
                    message: warningMessage,
                    type: 'warning',
                    margin: 'none',
                    stretch: true,
                } %}
            </div>
        {% elseif not defaultSenderId.enabled %}
            {% set warningMessage %}
            <strong>{{ 'Warning'|t('sms-manager') }}:</strong>
            {{ 'The default sender ID "{name}" is disabled. SMS functionality may not work.'|t('sms-manager', {name: defaultSenderId.name}) }}
            {% if not isDefaultFromConfig %}
                {{ 'Please enable it or set a different sender ID as default.'|t('sms-manager') }}
            {% else %}
                {{ 'Update your config/sms-manager.php to fix this.'|t('sms-manager') }}
            {% endif %}
            {% endset %}
            <div class="info-box-table-wrapper">
                {% include 'lindemannrock-base/_components/info-box' with {
                    message: warningMessage,
                    type: 'warning',
                    margin: 'none',
                    stretch: true,
                } %}
            </div>
        {% endif %}
    {% elseif senderIds|length > 0 %}
        {% set warningMessage %}
        <strong>{{ 'Warning'|t('sms-manager') }}:</strong>
        {{ 'No default sender ID is configured. Please set one of the sender IDs as default.'|t('sms-manager') }}
        {% endset %}
        <div class="info-box-table-wrapper">
            {% include 'lindemannrock-base/_components/info-box' with {
                message: warningMessage,
                type: 'warning',
                margin: 'none',
                stretch: true,
            } %}
        </div>
    {% endif %}
{% endblock %}


{# ============================================================================
   BULK ACTIONS (shown when items selected)
   ============================================================================ #}

{% block bulkActions %}
    {% if canEdit %}
        <div class="btngroup">
            <button type="button" class="btn menubtn secondary" id="lr-bulk-status-btn">
                {{ 'Set status'|t('app') }}
            </button>
            <div class="menu">
                <ul>
                    <li><a id="lr-bulk-enable-action">{{ 'Enable'|t('sms-manager') }}</a></li>
                    <li><a id="lr-bulk-disable-action">{{ 'Disable'|t('sms-manager') }}</a></li>
                </ul>
            </div>
        </div>
    {% endif %}
    {% if canDelete %}
        <button type="button" class="btn secondary" id="lr-bulk-delete-btn">
            {{ 'Delete'|t('app') }} (<span id="lr-selected-count">0</span>)
        </button>
    {% endif %}
{% endblock %}


{# ============================================================================
   ROW ACTIONS (per-row menu)
   ============================================================================ #}

{% block rowActions %}
    {% set isConfig = item.isFromConfig() %}
    {% set isDefault = defaultSenderIdHandle == item.handle %}

    <td class="thin" style="text-align: right;">
        <button type="button" class="btn menubtn" data-icon="settings" title="{{ 'Actions'|t('app') }}"></button>
        <div class="menu">
            <ul>
                {% if item.canEdit() %}
                    {% if canEdit %}
                        <li>
                            <a href="{{ url('sms-manager/sender-ids/' ~ item.id) }}">
                                {{ 'Edit'|t('app') }}
                            </a>
                        </li>
                    {% endif %}
                {% else %}
                    <li>
                        <a href="{{ url('sms-manager/sender-ids/view/' ~ item.handle) }}">
                            {{ 'View'|t('app') }}
                        </a>
                    </li>
                {% endif %}
                {% if canEdit and not isDefaultFromConfig and not isDefault %}
                    <li><hr class="padded"></li>
                    <li>
                        <a class="lr-sender-id-action" data-action="set-default" data-id="{{ item.id ?: item.handle }}" data-name="{{ item.name }}">
                            {{ 'Set as Default'|t('sms-manager') }}
                        </a>
                    </li>
                {% endif %}
                {% if canDelete and item.canEdit() and not isDefault %}
                    <li><hr class="padded"></li>
                    <li>
                        <a class="lr-sender-id-action error" data-action="delete" data-id="{{ item.id ?: item.handle }}" data-name="{{ item.name }}">
                            {{ 'Delete'|t('app') }}
                        </a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </td>
{% endblock %}


{# ============================================================================
   CUSTOM TABLE ROW RENDERING
   ============================================================================ #}

{% block tableRow %}
    {% set isConfig = item.isFromConfig() %}

    {# Find provider for this sender ID #}
    {% set provider = null %}
    {% for p in providers %}
        {% if p.handle == item.providerHandle %}
            {% set provider = p %}
        {% endif %}
    {% endfor %}

    {# Name #}
    <td>
        {% if item.canEdit() %}
            <a class="label-link" href="{{ url('sms-manager/sender-ids/' ~ item.id) }}">
                <span>{{ item.name }}</span>
            </a>
        {% else %}
            <a class="label-link" href="{{ url('sms-manager/sender-ids/view/' ~ item.handle) }}">
                <span>{{ item.name }}</span>
            </a>
            <span class="config-info-icon" data-config="{{ item.rawConfigDisplay|e('html_attr') }}"></span>
        {% endif %}
    </td>

    {# Handle #}
    <td><code>{{ item.handle }}</code></td>

    {# Sender ID value #}
    <td><code>{{ item.senderId }}</code></td>

    {# Provider badge #}
    <td>
        {% if provider %}
            {% set providerUrl = provider.canEdit() ? url('sms-manager/providers/' ~ provider.id) : url('sms-manager/providers/view/' ~ provider.handle) %}
            <a href="{{ providerUrl }}" style="text-decoration: none;">
                {% include 'lindemannrock-base/_components/badge' with {
                    label: provider.type|upper,
                    value: provider.type,
                    colorSet: 'smsProviderType',
                } only %}
            </a>
        {% else %}
            <span class="light">{{ 'Unknown'|t('sms-manager') }}</span>
        {% endif %}
    </td>

    {# Type badge (Dev/Production) #}
    <td>
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.isDev ? 'Development'|t('sms-manager') : 'Production'|t('sms-manager'),
            value: item.isDev ? 'development' : 'production',
            colorSet: 'environmentType',
        } only %}
    </td>

    {# Source badge #}
    <td>
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.source|capitalize,
            value: item.source,
            colorSet: 'configSource',
        } only %}
    </td>

    {# Status badge #}
    <td>
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.enabled ? 'Enabled'|t('sms-manager') : 'Disabled'|t('sms-manager'),
            value: item.enabled ? 'enabled' : 'disabled',
            colorSet: 'status',
        } only %}
    </td>

    {# Default indicator #}
    <td>
        {% if defaultSenderIdHandle == item.handle %}
            {% include 'lindemannrock-base/_components/badge' with {
                label: 'Yes'|t('sms-manager'),
                value: 'yes',
                colorSet: 'yesNo',
            } only %}
        {% else %}
            <span class="light">-</span>
        {% endif %}
    </td>
{% endblock %}


{# ============================================================================
   CUSTOM SCRIPTS
   ============================================================================ #}

{% block scripts %}
    <script>
    (function() {
        // Update selected count when selection changes
        document.addEventListener('lr:selectionChanged', function(e) {
            const countSpan = document.getElementById('lr-selected-count');
            if (countSpan) {
                countSpan.textContent = e.detail.count;
            }
        });

        // Bulk enable
        document.getElementById('lr-bulk-enable-action')?.addEventListener('click', function(e) {
            e.preventDefault();
            if (!window.lrTableSelection) return;

            const ids = window.lrTableSelection.getSelectedIds();
            if (ids.length === 0) return;

            Craft.sendActionRequest('POST', 'sms-manager/sender-ids/bulk-enable', {
                data: { senderIdIds: ids }
            }).then(function(response) {
                if (response.data.count > 0) {
                    Craft.cp.displayNotice('{{ "Enabled {count} sender IDs"|t("sms-manager")|e("js") }}'.replace('{count}', response.data.count));
                }
                if (response.data.errors && response.data.errors.length > 0) {
                    response.data.errors.forEach(err => Craft.cp.displayError(err));
                }
                if (response.data.count > 0) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('{{ "Failed to enable sender IDs"|t("sms-manager")|e("js") }}');
            });
        });

        // Bulk disable
        document.getElementById('lr-bulk-disable-action')?.addEventListener('click', function(e) {
            e.preventDefault();
            if (!window.lrTableSelection) return;

            const ids = window.lrTableSelection.getSelectedIds();
            if (ids.length === 0) return;

            Craft.sendActionRequest('POST', 'sms-manager/sender-ids/bulk-disable', {
                data: { senderIdIds: ids }
            }).then(function(response) {
                if (response.data.count > 0) {
                    Craft.cp.displayNotice('{{ "Disabled {count} sender IDs"|t("sms-manager")|e("js") }}'.replace('{count}', response.data.count));
                }
                if (response.data.errors && response.data.errors.length > 0) {
                    response.data.errors.forEach(err => Craft.cp.displayError(err));
                } else if (response.data.error) {
                    Craft.cp.displayError(response.data.error);
                }
                if (response.data.count > 0) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('{{ "Failed to disable sender IDs"|t("sms-manager")|e("js") }}');
            });
        });

        // Bulk delete
        document.getElementById('lr-bulk-delete-btn')?.addEventListener('click', function(e) {
            e.preventDefault();
            if (!window.lrTableSelection) return;

            const ids = window.lrTableSelection.getSelectedIds();
            const count = window.lrTableSelection.getCount();

            if (count === 0) return;

            if (!confirm('{{ "Delete {count} sender ID(s)? This cannot be undone."|t("sms-manager")|e("js") }}'.replace('{count}', count))) {
                return;
            }

            Craft.sendActionRequest('POST', 'sms-manager/sender-ids/bulk-delete', {
                data: { senderIdIds: ids }
            }).then(function(response) {
                if (response.data.count > 0) {
                    Craft.cp.displayNotice('{{ "Deleted {count} sender IDs"|t("sms-manager")|e("js") }}'.replace('{count}', response.data.count));
                }
                if (response.data.errors && response.data.errors.length > 0) {
                    response.data.errors.forEach(err => Craft.cp.displayError(err));
                } else if (response.data.error) {
                    Craft.cp.displayError(response.data.error);
                }
                if (response.data.count > 0) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('{{ "Failed to delete sender IDs"|t("sms-manager")|e("js") }}');
            });
        });

        // Individual sender ID action menu clicks
        document.querySelectorAll('.lr-sender-id-action').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                const action = this.dataset.action;
                const senderIdId = this.dataset.id;
                const senderIdName = this.dataset.name;

                if (action === 'set-default') {
                    Craft.sendActionRequest('POST', 'sms-manager/sender-ids/set-default', {
                        data: { senderIdId: senderIdId }
                    }).then(function(response) {
                        if (response.data.success) {
                            Craft.cp.displayNotice('{{ "Default sender ID updated"|t("sms-manager")|e("js") }}');
                            setTimeout(() => window.location.reload(), 500);
                        } else {
                            Craft.cp.displayError(response.data.error || '{{ "Failed to update default sender ID"|t("sms-manager")|e("js") }}');
                        }
                    }).catch(function(error) {
                        Craft.cp.displayError('{{ "Failed to update default sender ID"|t("sms-manager")|e("js") }}');
                    });
                } else if (action === 'delete') {
                    if (confirm('{{ "Delete sender ID \"{name}\"? This cannot be undone."|t("sms-manager")|e("js") }}'.replace('{name}', senderIdName))) {
                        Craft.sendActionRequest('POST', 'sms-manager/sender-ids/delete', {
                            data: { senderIdId: senderIdId }
                        }).then(function(response) {
                            if (response.data.success) {
                                Craft.cp.displayNotice('{{ "Sender ID deleted"|t("sms-manager")|e("js") }}');
                                setTimeout(() => window.location.reload(), 1000);
                            } else if (response.data.error) {
                                Craft.cp.displayError(response.data.error);
                            }
                        }).catch(function(error) {
                            Craft.cp.displayError('{{ "Failed to delete sender ID"|t("sms-manager")|e("js") }}');
                        });
                    }
                }
            });
        });
    })();
    </script>
{% endblock %}
