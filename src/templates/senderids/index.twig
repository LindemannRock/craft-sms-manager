{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}
{% import 'sms-manager/_macros/index' as indexMacros %}

{% set plugin = craft.app.plugins.getPlugin('sms-manager') %}

{% set title = 'Sender IDs'|t('sms-manager') %}
{% set fullPageForm = false %}
{% set selectedSubnavItem = 'sender-ids' %}

{# Permission checks #}
{% set canCreate = currentUser.can('smsManager:createSenderIds') %}
{% set canEdit = currentUser.can('smsManager:editSenderIds') %}
{% set canDelete = currentUser.can('smsManager:deleteSenderIds') %}
{% set showActionsColumn = canEdit or canDelete %}

{# Get query parameters #}
{% set search = craft.app.request.getParam('search', '') %}
{% set statusFilter = craft.app.request.getParam('status', 'all') %}
{% set sourceFilter = craft.app.request.getParam('source', 'all') %}
{% set providerFilter = craft.app.request.getParam('provider', 'all') %}
{% set testFilter = craft.app.request.getParam('test', 'all') %}
{% set sort = craft.app.request.getParam('sort', 'source') %}
{% set dir = craft.app.request.getParam('dir', 'asc') %}
{% set page = craft.app.request.getParam('page', 1)|number_format(0, '', '') %}
{% set limit = settings.itemsPerPage ?? 50 %}
{% set offset = (page - 1) * limit %}

{# Filter sender IDs #}
{% set filteredSenderIds = senderIds %}

{# Status filter #}
{% if statusFilter == 'enabled' %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => s.enabled) %}
{% elseif statusFilter == 'disabled' %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => not s.enabled) %}
{% endif %}

{# Source filter #}
{% if sourceFilter == 'config' %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => s.source == 'config') %}
{% elseif sourceFilter == 'database' %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => s.source != 'config') %}
{% endif %}

{# Provider filter #}
{% if providerFilter != 'all' %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => s.providerId == providerFilter or s.providerHandle == providerFilter) %}
{% endif %}

{# Test filter #}
{% if testFilter == 'test' %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => s.isTest) %}
{% elseif testFilter == 'production' %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => not s.isTest) %}
{% endif %}

{# Search filter #}
{% if search %}
    {% set filteredSenderIds = filteredSenderIds|filter(s => search|lower in s.name|lower or search|lower in s.handle|lower or search|lower in s.senderId|lower) %}
{% endif %}

{# Sort sender IDs #}
{% if sort == 'name' %}
    {% set filteredSenderIds = filteredSenderIds|sort((a, b) => dir == 'asc' ? a.name|lower <=> b.name|lower : b.name|lower <=> a.name|lower) %}
{% elseif sort == 'handle' %}
    {% set filteredSenderIds = filteredSenderIds|sort((a, b) => dir == 'asc' ? a.handle|lower <=> b.handle|lower : b.handle|lower <=> a.handle|lower) %}
{% elseif sort == 'senderId' %}
    {% set filteredSenderIds = filteredSenderIds|sort((a, b) => dir == 'asc' ? a.senderId|lower <=> b.senderId|lower : b.senderId|lower <=> a.senderId|lower) %}
{% elseif sort == 'source' %}
    {% set filteredSenderIds = filteredSenderIds|sort((a, b) => dir == 'asc' ? (a.source ?? '') <=> (b.source ?? '') : (b.source ?? '') <=> (a.source ?? '')) %}
{% elseif sort == 'isTest' %}
    {% set filteredSenderIds = filteredSenderIds|sort((a, b) => dir == 'asc' ? a.isTest <=> b.isTest : b.isTest <=> a.isTest) %}
{% elseif sort == 'enabled' %}
    {% set filteredSenderIds = filteredSenderIds|sort((a, b) => dir == 'asc' ? a.enabled <=> b.enabled : b.enabled <=> a.enabled) %}
{% endif %}

{% set totalCount = filteredSenderIds|length %}
{% set totalPages = (totalCount / limit)|round(0, 'ceil') %}
{% set paginatedSenderIds = filteredSenderIds|slice(offset, limit) %}

{% set crumbs = [
    { label: smsHelper.fullName, url: url('sms-manager') },
    { label: 'Sender IDs'|t('sms-manager'), url: url('sms-manager/sender-ids') }
] %}

{% block toolbar %}
    <div id="toolbar" class="flex" style="align-items: flex-end;">
        <div class="flex-grow">
            <form method="get" action="{{ url('sms-manager/sender-ids') }}">
                <div class="flex">
                    <div class="btngroup">
                        <button type="button" class="btn menubtn statusmenubtn">
                            <span class="status {{ statusFilter == 'all' ? 'all' : (statusFilter == 'enabled' ? 'green' : 'disabled') }}"></span>
                            {{ statusFilter == 'all' ? 'All'|t('sms-manager') : statusFilter|capitalize }}
                        </button>
                        <div class="menu">
                            <ul>
                                <li>
                                    <a class="{{ statusFilter == 'all' ? 'sel' : '' }}" href="?status=all&source={{ sourceFilter }}&provider={{ providerFilter }}&test={{ testFilter }}&search={{ search }}">
                                        <span class="status all"></span>{{ 'All'|t('sms-manager') }}
                                    </a>
                                </li>
                                <li>
                                    <a class="{{ statusFilter == 'enabled' ? 'sel' : '' }}" href="?status=enabled&source={{ sourceFilter }}&provider={{ providerFilter }}&test={{ testFilter }}&search={{ search }}">
                                        <span class="status green"></span>{{ 'Enabled'|t('sms-manager') }}
                                    </a>
                                </li>
                                <li>
                                    <a class="{{ statusFilter == 'disabled' ? 'sel' : '' }}" href="?status=disabled&source={{ sourceFilter }}&provider={{ providerFilter }}&test={{ testFilter }}&search={{ search }}">
                                        <span class="status disabled"></span>{{ 'Disabled'|t('sms-manager') }}
                                    </a>
                                </li>
                                {{ indexMacros.sourceFilterMenu(sourceFilter, statusFilter, search, {provider: providerFilter, test: testFilter}) }}
                                <li><hr class="padded"></li>
                                <li class="menu-header">{{ 'Provider'|t('sms-manager') }}</li>
                                <li>
                                    <a class="{{ providerFilter == 'all' ? 'sel' : '' }}" href="?status={{ statusFilter }}&source={{ sourceFilter }}&provider=all&test={{ testFilter }}&search={{ search }}">
                                        <span class="status all"></span>{{ 'All Providers'|t('sms-manager') }}
                                    </a>
                                </li>
                                {% for provider in providers %}
                                    <li>
                                        <a class="{{ providerFilter == provider.id or providerFilter == provider.handle ? 'sel' : '' }}" href="?status={{ statusFilter }}&source={{ sourceFilter }}&provider={{ provider.id ?: provider.handle }}&test={{ testFilter }}&search={{ search }}">
                                            <span class="status" style="background: {{ providerFilter == provider.id or providerFilter == provider.handle ? '#6366f1' : '#aab6c1' }};"></span>{{ provider.name }}
                                        </a>
                                    </li>
                                {% endfor %}
                                <li><hr class="padded"></li>
                                <li class="menu-header">{{ 'Type'|t('sms-manager') }}</li>
                                <li>
                                    <a class="{{ testFilter == 'all' ? 'sel' : '' }}" href="?status={{ statusFilter }}&source={{ sourceFilter }}&provider={{ providerFilter }}&test=all&search={{ search }}">
                                        <span class="status all"></span>{{ 'All Types'|t('sms-manager') }}
                                    </a>
                                </li>
                                <li>
                                    <a class="{{ testFilter == 'production' ? 'sel' : '' }}" href="?status={{ statusFilter }}&source={{ sourceFilter }}&provider={{ providerFilter }}&test=production&search={{ search }}">
                                        <span class="status" style="background: {{ testFilter == 'production' ? '#6366f1' : '#aab6c1' }};"></span>{{ 'Production'|t('sms-manager') }}
                                    </a>
                                </li>
                                <li>
                                    <a class="{{ testFilter == 'test' ? 'sel' : '' }}" href="?status={{ statusFilter }}&source={{ sourceFilter }}&provider={{ providerFilter }}&test=test&search={{ search }}">
                                        <span class="status" style="background: {{ testFilter == 'test' ? '#ec4899' : '#aab6c1' }};"></span>{{ 'Test'|t('sms-manager') }}
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="search-container texticon flex-grow">
                        <span class="texticon-icon search icon" aria-hidden="true"></span>
                        <input type="text" class="clearable text fullwidth" name="search" value="{{ search }}" placeholder="{{ 'Search sender IDs...'|t('sms-manager') }}" autocomplete="off" dir="ltr" aria-label="Search" {% if search %} autofocus {% endif %}>
                        <button type="button" class="clear-btn {{ search ? '' : 'hidden' }}" title="{{ 'Clear search'|t('sms-manager') }}" role="button" aria-label="{{ 'Clear search'|t('sms-manager') }}"></button>
                        <input type="hidden" name="status" value="{{ statusFilter }}">
                        <input type="hidden" name="source" value="{{ sourceFilter }}">
                        <input type="hidden" name="provider" value="{{ providerFilter }}">
                        <input type="hidden" name="test" value="{{ testFilter }}">
                        <input type="hidden" name="sort" value="{{ sort }}">
                        <input type="hidden" name="dir" value="{{ dir }}">
                    </div>
                </div>
            </form>
        </div>
        {% if canCreate %}
            <a href="{{ url('sms-manager/sender-ids/new') }}" class="btn submit add icon">
                {{ 'New Sender ID'|t('sms-manager') }}
            </a>
        {% endif %}
    </div>
{% endblock %}

{% css %}
.info-box-table-wrapper {
    padding-bottom: 14px;
}
@media (min-width: 769px) {
    .info-box-table-wrapper {
        padding-bottom: 46px;
    }
}
{% endcss %}

{% block content %}
{% include 'sms-manager/_partials/common/index-styles' %}

{# Warning if default sender ID is missing or disabled #}
{% if defaultSenderIdHandle %}
    {% set defaultSenderId = senderIds|filter(s => s.handle == defaultSenderIdHandle)|first %}
    {% if not defaultSenderId %}
        {# Default sender ID doesn't exist #}
        {% set warningMessage %}
        <strong>{{ 'Warning'|t('sms-manager') }}:</strong>
        {{ 'The default sender ID handle "{handle}" does not exist.'|t('sms-manager', {handle: defaultSenderIdHandle}) }}
        {% if isDefaultFromConfig %}
            {{ 'Update your config/sms-manager.php to point to a valid sender ID handle.'|t('sms-manager') }}
        {% else %}
            {{ 'Please set a different sender ID as default.'|t('sms-manager') }}
        {% endif %}
        {% endset %}
        <div class="info-box-table-wrapper">
            {% include 'lindemannrock-base/_components/info-box' with {
                message: warningMessage,
                type: 'warning',
                margin: 'none',
                stretch: true,
            } %}
        </div>
    {% elseif not defaultSenderId.enabled %}
        {# Default sender ID exists but is disabled #}
        {% set warningMessage %}
        <strong>{{ 'Warning'|t('sms-manager') }}:</strong>
        {{ 'The default sender ID "{name}" is disabled. SMS functionality may not work.'|t('sms-manager', {name: defaultSenderId.name}) }}
        {% if not isDefaultFromConfig %}
            {{ 'Please enable it or set a different sender ID as default.'|t('sms-manager') }}
        {% else %}
            {{ 'Update your config/sms-manager.php to fix this.'|t('sms-manager') }}
        {% endif %}
        {% endset %}
        <div class="info-box-table-wrapper">
            {% include 'lindemannrock-base/_components/info-box' with {
                message: warningMessage,
                type: 'warning',
                margin: 'none',
                stretch: true,
            } %}
        </div>
    {% endif %}
{% elseif senderIds|length > 0 %}
    {# No default handle set but sender IDs exist #}
    {% set warningMessage %}
    <strong>{{ 'Warning'|t('sms-manager') }}:</strong>
    {{ 'No default sender ID is configured. Please set one of the sender IDs as default.'|t('sms-manager') }}
    {% endset %}
    <div class="info-box-table-wrapper">
        {% include 'lindemannrock-base/_components/info-box' with {
            message: warningMessage,
            type: 'warning',
            margin: 'none',
            stretch: true,
        } %}
    </div>
{% endif %}

    <div id="elements" class="elements">
        <div class="tableview tablepane">
            <table class="data fullwidth">
                <thead>
                    <tr>
                        <th class="checkbox-cell selectallcontainer">
                            <div class="checkbox" role="checkbox" tabindex="0" aria-checked="false" aria-label="Select all"></div>
                        </th>
                        <th scope="col" data-attribute="name" class="orderable {{ sort == 'name' ? 'ordered ' ~ dir : '' }}">
                            <button type="button" data-sort="name">{{ 'Name'|t('sms-manager') }}</button>
                        </th>
                        <th scope="col" data-attribute="handle" class="orderable {{ sort == 'handle' ? 'ordered ' ~ dir : '' }}">
                            <button type="button" data-sort="handle">{{ 'Handle'|t('sms-manager') }}</button>
                        </th>
                        <th scope="col" data-attribute="senderId" class="orderable {{ sort == 'senderId' ? 'ordered ' ~ dir : '' }}">
                            <button type="button" data-sort="senderId">{{ 'Sender ID'|t('sms-manager') }}</button>
                        </th>
                        <th scope="col">{{ 'Provider'|t('sms-manager') }}</th>
                        <th scope="col" data-attribute="source" class="orderable {{ sort == 'source' ? 'ordered ' ~ dir : '' }}">
                            <button type="button" data-sort="source">{{ 'Source'|t('sms-manager') }}</button>
                        </th>
                        <th scope="col" data-attribute="isTest" class="orderable {{ sort == 'isTest' ? 'ordered ' ~ dir : '' }}">
                            <button type="button" data-sort="isTest">{{ 'Test'|t('sms-manager') }}</button>
                        </th>
                        <th scope="col" data-attribute="enabled" class="orderable {{ sort == 'enabled' ? 'ordered ' ~ dir : '' }}">
                            <button type="button" data-sort="enabled">{{ 'Status'|t('sms-manager') }}</button>
                        </th>
                        <th scope="col">{{ 'Default'|t('sms-manager') }}</th>
                        {% if showActionsColumn %}
                            <th class="thin" style="width: 60px;">{{ 'Actions'|t('sms-manager') }}</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% if paginatedSenderIds|length %}
                        {% for senderId in paginatedSenderIds %}
                            {% set isConfig = senderId.isFromConfig() %}
                            {% set provider = null %}
                            {% for p in providers %}
                                {% if p.id == senderId.providerId or p.handle == senderId.providerHandle %}
                                    {% set provider = p %}
                                {% endif %}
                            {% endfor %}
                            <tr data-id="{{ senderId.id ?: senderId.handle }}" data-name="{{ senderId.name|e('html_attr') }}" data-source="{{ senderId.source }}">
                                <td class="checkbox-cell">
                                    {% if isConfig %}
                                        {{ indexMacros.disabledCheckbox('Config sender IDs cannot be modified'|t('sms-manager')) }}
                                    {% else %}
                                        <div class="checkbox" title="Select" tabindex="0" aria-checked="false" role="checkbox"></div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if senderId.canEdit() %}
                                        <a class="label-link" href="{{ url('sms-manager/sender-ids/' ~ senderId.id) }}">
                                            <span>{{ senderId.name }}</span>
                                        </a>
                                    {% else %}
                                        <a class="label-link" href="{{ url('sms-manager/sender-ids/view/' ~ senderId.handle) }}">
                                            <span>{{ senderId.name }}</span>
                                        </a>
                                        {{ indexMacros.configInfoIcon(senderId.rawConfigDisplay) }}
                                    {% endif %}
                                </td>
                                <td><code>{{ senderId.handle }}</code></td>
                                <td><code>{{ senderId.senderId }}</code></td>
                                <td>
                                    {% if provider %}
                                        {{ indexMacros.providerTypeBadge(provider.type, provider.name) }}
                                    {% else %}
                                        <span class="light">{{ 'Unknown'|t('sms-manager') }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ indexMacros.sourceBadge(senderId.source) }}
                                </td>
                                <td>
                                    {{ indexMacros.testBadge(senderId.isTest) }}
                                    {% if not senderId.isTest %}
                                        <span class="light">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ indexMacros.statusBadge(senderId.enabled) }}
                                </td>
                                <td>
                                    {% if defaultSenderIdHandle == senderId.handle %}
                                        <span class="status-label green">
                                            <span class="status green"></span>
                                            <span class="status-label-text">{{ 'Yes'|t('sms-manager') }}</span>
                                        </span>
                                    {% else %}
                                        <span class="light">-</span>
                                    {% endif %}
                                </td>
                                {% if showActionsColumn %}
                                    <td class="thin" style="text-align: right;">
                                        <button type="button" class="btn menubtn" data-icon="settings" title="{{ 'Actions'|t('sms-manager') }}"></button>
                                        <div class="menu">
                                            <ul>
                                                {% if senderId.canEdit() %}
                                                    {% if canEdit %}
                                                        <li>
                                                            <a href="{{ url('sms-manager/sender-ids/' ~ senderId.id) }}">
                                                                {{ 'Edit'|t('sms-manager') }}
                                                            </a>
                                                        </li>
                                                    {% endif %}
                                                {% else %}
                                                    <li>
                                                        <a href="{{ url('sms-manager/sender-ids/view/' ~ senderId.handle) }}">
                                                            {{ 'View'|t('sms-manager') }}
                                                        </a>
                                                    </li>
                                                {% endif %}
                                                {% set isDefault = defaultSenderIdHandle == senderId.handle %}
                                                {% if canEdit and not isDefaultFromConfig and not isDefault %}
                                                    <li><hr class="padded"></li>
                                                    <li>
                                                        <a class="sender-id-action" data-action="set-default" data-id="{{ senderId.id ?: senderId.handle }}" data-name="{{ senderId.name }}">
                                                            {{ 'Set as Default'|t('sms-manager') }}
                                                        </a>
                                                    </li>
                                                {% endif %}
                                                {% if canDelete and senderId.canEdit() and not isDefault %}
                                                    <li><hr class="padded"></li>
                                                    <li>
                                                        <a class="sender-id-action error" data-action="delete" data-id="{{ senderId.id ?: senderId.handle }}" data-name="{{ senderId.name }}">
                                                            {{ 'Delete'|t('sms-manager') }}
                                                        </a>
                                                    </li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="{{ showActionsColumn ? 10 : 9 }}" style="text-align: center; padding: 2em;">
                                {{ 'No sender IDs found.'|t('sms-manager') }}
                                {% if canCreate %}
                                    <a href="{{ url('sms-manager/sender-ids/new') }}">{{ 'Create one'|t('sms-manager') }}</a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    {# Pagination footer #}
    <div id="footer" class="flex flex-justify">
        <div class="light">
            <div class="flex pagination">
                <nav class="flex" aria-label="sender ID pagination">
                    <button type="button" class="page-link prev-page {{ page <= 1 ? 'disabled' : '' }}" {{ page <= 1 ? 'disabled' : '' }} title="{{ 'Previous Page'|t('sms-manager') }}"></button>
                    <button type="button" class="page-link next-page {{ page >= totalPages ? 'disabled' : '' }}" {{ page >= totalPages ? 'disabled' : '' }} title="{{ 'Next Page'|t('sms-manager') }}"></button>
                </nav>
                <div class="page-info" style="margin: 0 12px; color: #596673;">
                    {% set endRange = min(offset + limit, totalCount) %}
                    {% if totalCount == 0 %}
                        {{ 'no sender IDs'|t('sms-manager') }}
                    {% else %}
                        {{ offset + 1 }} â€“ {{ endRange }} {{ 'of'|t('sms-manager') }} {{ totalCount }} {{ totalCount == 1 ? 'sender ID'|t('sms-manager') : 'sender IDs'|t('sms-manager') }}
                    {% endif %}
                </div>
            </div>
        </div>
        <div id="actions-container" class="flex" style="display: none;">
            {% if canEdit %}
                <div>
                    <button type="button" class="btn menubtn secondary" id="bulk-actions-btn" aria-label="Set status">
                        {{ 'Set status'|t('app') }}
                    </button>
                    <div class="menu">
                        <ul>
                            <li><a id="bulk-enable-action">{{ 'Enable'|t('sms-manager') }}</a></li>
                            <li><a id="bulk-disable-action">{{ 'Disable'|t('sms-manager') }}</a></li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            {% if canDelete %}
                <button type="button" class="btn secondary" id="bulk-delete-btn">
                    <span id="delete-label">{{ 'Delete'|t('sms-manager') }}</span>
                </button>
            {% endif %}
        </div>
    </div>

    <script>
        // Initialize menu buttons
        document.querySelectorAll('.menubtn').forEach(btn => {
            if (typeof Craft !== 'undefined' && Craft.MenuBtn) {
                new Craft.MenuBtn(btn);
            }
        });

        // Clear search
        const clearBtn = document.querySelector('.clear-btn');
        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                const searchInput = document.querySelector('input[name="search"]');
                searchInput.value = '';
                searchInput.form.submit();
            });
        }

        // Search on Enter
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput) {
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    this.form.submit();
                }
            });
        }

        // Sort buttons
        document.querySelectorAll('th.orderable button').forEach(button => {
            button.addEventListener('click', function() {
                const sortField = this.dataset.sort;
                const currentSort = '{{ sort }}';
                const currentDir = '{{ dir }}';
                let newDir = 'asc';

                if (sortField === currentSort) {
                    newDir = currentDir === 'asc' ? 'desc' : 'asc';
                }

                window.location.href = '?status={{ statusFilter }}&source={{ sourceFilter }}&provider={{ providerFilter }}&test={{ testFilter }}&search={{ search }}&sort=' + sortField + '&dir=' + newDir + '&page=1';
            });
        });

        // Pagination
        document.querySelector('.prev-page:not(.disabled)')?.addEventListener('click', function() {
            window.location.href = '?status={{ statusFilter }}&source={{ sourceFilter }}&provider={{ providerFilter }}&test={{ testFilter }}&search={{ search }}&sort={{ sort }}&dir={{ dir }}&page={{ page - 1 }}';
        });

        document.querySelector('.next-page:not(.disabled)')?.addEventListener('click', function() {
            window.location.href = '?status={{ statusFilter }}&source={{ sourceFilter }}&provider={{ providerFilter }}&test={{ testFilter }}&search={{ search }}&sort={{ sort }}&dir={{ dir }}&page={{ page + 1 }}';
        });

        // Checkbox functionality
        const selectAllCheckbox = document.querySelector('.selectallcontainer .checkbox');
        const checkboxes = document.querySelectorAll('tbody .checkbox:not(.disabled)');
        let selectedIds = new Set();

        function toggleCheckbox(checkbox, checked) {
            if (checked) {
                checkbox.classList.add('checked');
                checkbox.setAttribute('aria-checked', 'true');
            } else {
                checkbox.classList.remove('checked');
                checkbox.setAttribute('aria-checked', 'false');
            }
        }

        function updateBulkButtons() {
            const hasSelection = selectedIds.size > 0;
            const actionsContainer = document.getElementById('actions-container');
            const deleteLabel = document.getElementById('delete-label');

            if (hasSelection) {
                actionsContainer.style.display = '';
                const count = selectedIds.size;
                if (deleteLabel) {
                    deleteLabel.textContent = `{{ 'Delete'|t('sms-manager') }} (${count})`;
                }
            } else {
                actionsContainer.style.display = 'none';
            }
        }

        // Select all
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('click', function() {
                const isChecked = !this.classList.contains('checked');
                toggleCheckbox(this, isChecked);

                checkboxes.forEach(checkbox => {
                    toggleCheckbox(checkbox, isChecked);
                    const id = checkbox.closest('tr').dataset.id;
                    if (isChecked) {
                        selectedIds.add(id);
                    } else {
                        selectedIds.delete(id);
                    }
                });

                updateBulkButtons();
            });
        }

        // Individual checkboxes
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('click', function() {
                const isChecked = !this.classList.contains('checked');
                toggleCheckbox(this, isChecked);

                const id = this.closest('tr').dataset.id;
                if (isChecked) {
                    selectedIds.add(id);
                } else {
                    selectedIds.delete(id);
                }

                updateBulkButtons();
            });
        });

        // Initialize bulk actions menu button
        const bulkActionsBtn = document.getElementById('bulk-actions-btn');
        if (bulkActionsBtn) {
            if (typeof Craft !== 'undefined' && Craft.MenuBtn) {
                new Craft.MenuBtn(bulkActionsBtn);
            }
        }

        // Bulk enable
        document.getElementById('bulk-enable-action')?.addEventListener('click', function(e) {
            e.preventDefault();
            const ids = Array.from(selectedIds);

            Craft.sendActionRequest('POST', 'sms-manager/sender-ids/bulk-enable', {
                data: { senderIdIds: ids }
            }).then(function(response) {
                if (response.data.count > 0) {
                    Craft.cp.displayNotice(`{{ 'Enabled'|t('sms-manager') }} ${response.data.count} {{ 'sender IDs'|t('sms-manager') }}`);
                }
                if (response.data.errors && response.data.errors.length > 0) {
                    response.data.errors.forEach(err => Craft.cp.displayError(err));
                }
                if (response.data.count > 0 && (!response.data.errors || response.data.errors.length === 0)) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('{{ 'Failed to enable sender IDs'|t('sms-manager') }}');
            });
        });

        // Bulk disable
        document.getElementById('bulk-disable-action')?.addEventListener('click', function(e) {
            e.preventDefault();
            const ids = Array.from(selectedIds);

            Craft.sendActionRequest('POST', 'sms-manager/sender-ids/bulk-disable', {
                data: { senderIdIds: ids }
            }).then(function(response) {
                if (response.data.count > 0) {
                    Craft.cp.displayNotice(`{{ 'Disabled'|t('sms-manager') }} ${response.data.count} {{ 'sender IDs'|t('sms-manager') }}`);
                }
                if (response.data.errors && response.data.errors.length > 0) {
                    response.data.errors.forEach(err => Craft.cp.displayError(err));
                } else if (response.data.error) {
                    Craft.cp.displayError(response.data.error);
                }
                if (response.data.count > 0 && (!response.data.errors || response.data.errors.length === 0)) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('{{ 'Failed to disable sender IDs'|t('sms-manager') }}');
            });
        });

        // Bulk delete
        document.getElementById('bulk-delete-btn')?.addEventListener('click', function() {
            const ids = Array.from(selectedIds);
            if (!confirm(`{{ 'Delete'|t('sms-manager') }} ${ids.length} {{ 'sender ID(s)? This cannot be undone.'|t('sms-manager') }}`)) return;

            Craft.sendActionRequest('POST', 'sms-manager/sender-ids/bulk-delete', {
                data: { senderIdIds: ids }
            }).then(function(response) {
                if (response.data.count > 0) {
                    Craft.cp.displayNotice(`{{ 'Deleted'|t('sms-manager') }} ${response.data.count} {{ 'sender IDs'|t('sms-manager') }}`);
                }
                if (response.data.errors && response.data.errors.length > 0) {
                    response.data.errors.forEach(err => Craft.cp.displayError(err));
                } else if (response.data.error) {
                    Craft.cp.displayError(response.data.error);
                }
                if (response.data.count > 0 && (!response.data.errors || response.data.errors.length === 0)) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('{{ 'Failed to delete sender IDs'|t('sms-manager') }}');
            });
        });

        // Individual sender ID action menu clicks
        document.querySelectorAll('.sender-id-action').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                const action = this.dataset.action;
                const senderIdId = this.dataset.id;
                const senderIdName = this.dataset.name;

                if (action === 'set-default') {
                    Craft.sendActionRequest('POST', 'sms-manager/sender-ids/set-default', {
                        data: { senderIdId: senderIdId }
                    }).then(function(response) {
                        if (response.data.success) {
                            Craft.cp.displayNotice('{{ "Default sender ID updated"|t('sms-manager') }}');
                            setTimeout(() => window.location.reload(), 500);
                        } else {
                            Craft.cp.displayError(response.data.error || '{{ "Failed to update default sender ID"|t('sms-manager') }}');
                        }
                    }).catch(function(error) {
                        Craft.cp.displayError('{{ "Failed to update default sender ID"|t('sms-manager') }}');
                    });
                } else if (action === 'delete') {
                    if (confirm('{{ 'Delete sender ID "{name}"? This cannot be undone.'|t('sms-manager') }}'.replace('{name}', senderIdName))) {
                        Craft.sendActionRequest('POST', 'sms-manager/sender-ids/delete', {
                            data: { senderIdId: senderIdId }
                        }).then(function(response) {
                            if (response.data.success) {
                                Craft.cp.displayNotice('{{ 'Sender ID deleted'|t('sms-manager') }}');
                                setTimeout(() => window.location.reload(), 1000);
                            } else if (response.data.error) {
                                Craft.cp.displayError(response.data.error);
                            }
                        }).catch(function(error) {
                            Craft.cp.displayError('{{ 'Failed to delete sender ID'|t('sms-manager') }}');
                        });
                    }
                }
            });
        });

        // Config tooltip for config-based sender IDs
        let activeTooltip = null;

        document.querySelectorAll('.config-info-icon').forEach(info => {
            info.addEventListener('mouseenter', function(e) {
                const config = this.dataset.config;
                if (!config) return;

                // Remove any existing tooltip
                if (activeTooltip) {
                    activeTooltip.remove();
                }

                // Create tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'config-tooltip';
                tooltip.textContent = config;
                document.body.appendChild(tooltip);
                activeTooltip = tooltip;

                // Position tooltip
                const rect = this.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();

                let left = rect.left + window.scrollX;
                let top = rect.bottom + window.scrollY + 8;

                // Keep within viewport
                if (left + tooltipRect.width > window.innerWidth - 20) {
                    left = window.innerWidth - tooltipRect.width - 20;
                }

                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
            });

            info.addEventListener('mouseleave', function() {
                if (activeTooltip) {
                    activeTooltip.remove();
                    activeTooltip = null;
                }
            });
        });
    </script>
{% endblock %}
