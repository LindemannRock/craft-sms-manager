{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set plugin = craft.app.plugins.getPlugin('sms-manager') %}
{% set title = isNew ? 'New Sender ID'|t('sms-manager') : 'Edit Sender ID'|t('sms-manager') %}
{% set fullPageForm = true %}
{% set selectedSubnavItem = 'sender-ids' %}
{% set saveShortcutRedirect = cpUrl('sms-manager/sender-ids/{id}') %}
{% set retainScrollOnSaveShortcut = true %}

{% set crumbs = [
    { label: smsHelper.fullName, url: url('sms-manager') },
    { label: 'Sender IDs'|t('sms-manager'), url: url('sms-manager/sender-ids') },
    { label: isNew ? 'New Sender ID'|t('sms-manager') : senderId.name }
] %}

{# Set up tabs #}
{% set tabs = {
    fields: {
        label: 'Settings'|t('sms-manager'),
        url: '#fields',
    },
} %}

{% block actionButton %}
    <div class="btngroup submit">
        <button type="submit" class="btn submit">{{ "Save"|t('app') }}</button>
        <button type="button" class="btn submit menubtn"></button>
        <div class="menu">
            <ul role="listbox">
                <li>
                    <a class="formsubmit" role="option" tabindex="0" data-redirect="{{ cpUrl('sms-manager/sender-ids/{id}')|hash }}">
                        <span class="label">{{ 'Save and continue editing'|t('app') }}</span>
                        <span class="shortcut" id="save-shortcut"></span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    {% if not isNew and currentUser.can('smsManager:deleteSenderIds') %}
        <button type="button" id="action-btn" class="btn menubtn action-btn hairline-dark m" title="{{ 'Actions'|t('app') }}" aria-controls="action-menu" aria-label="{{ 'Actions'|t('app') }}" data-disclosure-trigger="true" aria-expanded="false"></button>
        <div id="action-menu" class="menu menu--disclosure">
            <ul>
                <li>
                    <button class="menu-item error formsubmit" data-destructive data-action="sms-manager/sender-ids/delete" data-params='{"senderIdId":{{ senderId.id }}}' data-confirm="{{ 'Are you sure you want to delete this sender ID?'|t('sms-manager') }}" data-redirect="{{ 'sms-manager/sender-ids'|hash }}" data-headers='{"Accept":"application/json"}'>
                        <span class="icon">{{ svg('@app/icons/trash.svg') }}</span>
                        <span class="menu-item-label">{{ "Delete"|t('app') }}</span>
                    </button>
                </li>
            </ul>
        </div>
    {% endif %}
{% endblock %}

{% block content %}
    <input type="hidden" name="action" value="sms-manager/sender-ids/save">
    <input type="hidden" name="redirect" value="{{ 'sms-manager/sender-ids'|hash }}">
    {% if not isNew %}
        <input type="hidden" name="senderIdId" value="{{ senderId.id }}">
    {% endif %}
    {{ csrfInput() }}

    <div id="fields">
        {{ forms.selectField({
            first: true,
            label: 'Provider'|t('sms-manager'),
            instructions: 'The provider this sender ID belongs to'|t('sms-manager'),
            id: 'providerId',
            name: 'providerId',
            value: senderId.providerId ?? '',
            options: providerOptions,
            required: true,
            errors: senderId ? senderId.getErrors('providerId') : [],
        }) }}

        {{ forms.textField({
            label: 'Name'|t('sms-manager'),
            instructions: 'A friendly name for this sender ID'|t('sms-manager'),
            id: 'name',
            name: 'name',
            value: senderId.name ?? '',
            required: true,
            errors: senderId ? senderId.getErrors('name') : [],
        }) }}

        {{ forms.textField({
            label: 'Handle'|t('sms-manager'),
            instructions: 'How you will refer to this sender ID in code'|t('sms-manager'),
            id: 'handle',
            name: 'handle',
            class: 'code',
            value: senderId.handle ?? '',
            errors: senderId ? senderId.getErrors('handle') : [],
        }) }}

        {{ forms.textField({
            label: 'Sender ID'|t('sms-manager'),
            instructions: 'The actual sender ID value (e.g., phone number or alphanumeric ID)'|t('sms-manager'),
            id: 'senderId',
            name: 'senderId',
            class: 'code',
            value: senderId.senderId ?? '',
            required: true,
            errors: senderId ? senderId.getErrors('senderId') : [],
        }) }}

        {{ forms.textareaField({
            label: 'Description'|t('sms-manager'),
            instructions: 'Optional description for this sender ID'|t('sms-manager'),
            id: 'description',
            name: 'description',
            value: senderId.description ?? '',
            rows: 3,
        }) }}
    </div>
{% endblock %}

{% block details %}
    <fieldset>
        <legend class="h6">{{ 'Status'|t('sms-manager') }}</legend>
        <div class="meta">
            {{ forms.lightswitchField({
                label: 'Enabled'|t('sms-manager'),
                id: 'enabled',
                name: 'enabled',
                on: senderId.enabled ?? true
            }) }}
        </div>
    </fieldset>

    <fieldset>
        <legend class="h6">{{ 'Options'|t('sms-manager') }}</legend>
        <div class="meta">
            {{ forms.lightswitchField({
                label: 'Default Sender ID'|t('sms-manager'),
                id: 'isDefault',
                name: 'isDefault',
                on: senderId.isDefault ?? false
            }) }}

            {{ forms.lightswitchField({
                label: 'Test Sender ID'|t('sms-manager'),
                id: 'isTest',
                name: 'isTest',
                on: senderId.isTest ?? false
            }) }}
        </div>
    </fieldset>

    {% if not isNew %}
        <fieldset>
            <legend class="h6">{{ 'Meta'|t('sms-manager') }}</legend>
            <dl class="meta read-only">
                <div class="data">
                    <dt class="heading">{{ 'Status'|t('sms-manager') }}</dt>
                    <dd class="value">
                        <span class="status {{ senderId.enabled ? 'live' : 'disabled' }}"></span>
                        <span>{{ senderId.enabled ? 'Enabled'|t('sms-manager') : 'Disabled'|t('sms-manager') }}</span>
                    </dd>
                </div>
                <div class="data">
                    <dt class="heading">{{ 'ID'|t('app') }}</dt>
                    <dd class="value">{{ senderId.id }}</dd>
                </div>
                <div class="data">
                    <dt class="heading">{{ 'Created'|t('app') }}</dt>
                    <dd class="value">{{ senderId.dateCreated|datetime('short') }}</dd>
                </div>
                <div class="data">
                    <dt class="heading">{{ 'Updated'|t('app') }}</dt>
                    <dd class="value">{{ senderId.dateUpdated|datetime('short') }}</dd>
                </div>
            </dl>
        </fieldset>
    {% endif %}
{% endblock %}

{% js %}
// Auto-generate handle from name
const nameField = document.getElementById('name');
const handleField = document.getElementById('handle');
let handleChanged = {{ (senderId.handle ?? '') ? 'true' : 'false' }};

handleField.addEventListener('input', function() {
    handleChanged = true;
});

nameField.addEventListener('input', function() {
    if (!handleChanged) {
        handleField.value = this.value
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
    }
});

// Set platform-specific keyboard shortcut
const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
const saveShortcut = document.getElementById('save-shortcut');
if (saveShortcut) {
    saveShortcut.textContent = isMac ? 'âŒ˜S' : 'Ctrl+S';
}
{% endjs %}
