{% extends "sms-manager/_layouts/settings" %}
{% import "_includes/forms" as forms %}

{% set title = "Test SMS"|t('sms-manager') %}
{% set selectedSettingsItem = 'test' %}

{# Build dial code mapping for all countries from base helper - defined at template level for JS #}
{% set allDialCodes = [] %}
{% for option in lrDialCodes() %}
    {% set dc = lrDialCode(option.value) %}
    {% if dc %}
        {% set allDialCodes = allDialCodes|merge([{
            country: option.value,
            dialCode: dc,
            label: option.value ~ ' +' ~ dc
        }]) %}
    {% endif %}
{% endfor %}

{% set plugin = craft.app.plugins.getPlugin('sms-manager') %}
{% set crumbs = [
    {
        label: smsHelper.fullName|t('sms-manager'),
        url: url('sms-manager'),
    },
    {
        label: 'Settings'|t('sms-manager'),
        url: url('sms-manager/settings'),
    },
    {
        label: 'Test'|t('sms-manager'),
        url: url('sms-manager/settings/test'),
    },
] %}

{% block content %}

    <h2 style="margin-top: 0px;">{{ "Test SMS Sending"|t('sms-manager') }}</h2>

    <p>{{ "Test your SMS provider configuration by sending a test message. This will use the actual provider API and may incur costs."|t('sms-manager') }}</p>

    {% if not providers|length %}
        <div class="pane" style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 16px;">
            <p style="margin: 0;"><strong>{{ 'No providers configured.'|t('sms-manager') }}</strong></p>
            <p style="margin: 8px 0 0;">{{ 'Please configure at least one provider before testing.'|t('sms-manager') }}</p>
            <a href="{{ url('sms-manager/providers/new') }}" class="btn" style="margin-top: 12px;">{{ 'Add Provider'|t('sms-manager') }}</a>
        </div>
    {% elseif not senderIds|length %}
        <div class="pane" style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 16px;">
            <p style="margin: 0;"><strong>{{ 'No sender IDs configured.'|t('sms-manager') }}</strong></p>
            <p style="margin: 8px 0 0;">{{ 'Please configure at least one sender ID before testing.'|t('sms-manager') }}</p>
            <a href="{{ url('sms-manager/sender-ids/new') }}" class="btn" style="margin-top: 12px;">{{ 'Add Sender ID'|t('sms-manager') }}</a>
        </div>
    {% else %}
        <div class="pane" style="margin-bottom: 24px;">
            <h3 style="margin-top: 0;">{{ "SMS Configuration"|t('sms-manager') }}</h3>

            {{ forms.selectField({
                label: 'Provider'|t('sms-manager'),
                instructions: 'Select the SMS provider to use'|t('sms-manager'),
                id: 'testProvider',
                name: 'testProvider',
                options: providerOptions,
                value: defaultProviderId,
            }) }}

            {{ forms.selectField({
                label: 'Sender ID'|t('sms-manager'),
                instructions: 'Select the sender ID to use'|t('sms-manager'),
                id: 'testSenderId',
                name: 'testSenderId',
                options: senderIdOptions,
                value: defaultSenderIdId,
            }) }}

            <div id="apiKeyInfo" style="display: none;">
                {% include 'lindemannrock-base/_components/info-box' with {
                    message: '<span id="apiKeyInfoMessage"></span>',
                    type: 'info',
                    margin: 'none',
                    bg: 'white'
                } %}
            </div>

            {# Phone number with country code selector #}
            <div class="field" id="recipientField">
                <div class="heading">
                    <label for="testRecipient">{{ 'Recipient Phone Number'|t('sms-manager') }}</label>
                    <div class="instructions">
                        <p>{{ 'Enter phone number. Paste with country code to auto-detect.'|t('sms-manager') }}</p>
                    </div>
                </div>
                <div class="input">
                    <div style="display: flex; align-items: stretch;">
                        <div class="select" style="flex-shrink: 0;">
                            <select id="testCountry" name="testCountry" style="border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; height: 100%;">
                                {# Options populated by JS based on provider #}
                            </select>
                        </div>
                        <input type="text"
                               id="testRecipient"
                               name="testRecipient"
                               class="text code"
                               style="border-top-left-radius: 0; border-bottom-left-radius: 0; flex: 1; min-width: 0;"
                               autocomplete="off"
                               autocorrect="off"
                               autocapitalize="off"
                               inputmode="tel"
                               placeholder="{{ 'e.g., 94400999'|t('sms-manager') }}">
                    </div>
                </div>
            </div>

            {{ forms.textareaField({
                label: 'Message'|t('sms-manager'),
                instructions: 'Enter the message to send. Keep it short for testing.'|t('sms-manager'),
                id: 'testMessage',
                name: 'testMessage',
                value: 'This is a test SMS from SMS Manager.',
                rows: 3,
            }) }}

            {% set languageOptions = [] %}
            {% set seenLanguages = [] %}
            {% for site in craft.app.sites.getAllSites() %}
                {% set langCode = site.language|split('-')|first %}
                {% if langCode not in seenLanguages %}
                    {% set seenLanguages = seenLanguages|merge([langCode]) %}
                    {% set languageOptions = languageOptions|merge([{
                        label: site.language ~ ' (' ~ site.name ~ ')',
                        value: langCode
                    }]) %}
                {% endif %}
            {% endfor %}

            {{ forms.selectField({
                label: 'Language'|t('sms-manager'),
                instructions: 'Select the message language (affects character encoding)'|t('sms-manager'),
                id: 'testLanguage',
                name: 'testLanguage',
                options: languageOptions,
                value: languageOptions[0].value ?? 'en',
            }) }}

            <div id="message-info" style="padding: 12px; background: #f3f4f6; border-radius: 4px; margin-bottom: 20px;">
                <span id="char-count">0</span> {{ 'characters'|t('sms-manager') }}
                <span class="light" style="margin-left: 12px;">|</span>
                <span style="margin-left: 12px;"><span id="sms-count">1</span> {{ 'SMS part(s)'|t('sms-manager') }}</span>
            </div>

            <div style="display: flex; gap: 10px; align-items: center;">
                <button type="button" id="testButton" class="btn submit">{{ "Send Test SMS"|t('sms-manager') }}</button>
                <span id="testStatus" style="font-size: 0.9em;"></span>
            </div>
        </div>

        <div id="testResults" style="display: none;">
            <div class="pane">
                <h3 id="resultsTitle" style="margin-top: 0;"></h3>
                <div id="resultsContent"></div>
            </div>
        </div>
    {% endif %}

    {% include 'lindemannrock-base/_components/plugin-credit' %}
{% endblock %}

{% js %}
const testButton = document.getElementById('testButton');
const testProviderSelect = document.getElementById('testProvider');
const testSenderIdSelect = document.getElementById('testSenderId');
const testCountrySelect = document.getElementById('testCountry');
const testRecipientInput = document.getElementById('testRecipient');
const testMessageInput = document.getElementById('testMessage');
const testLanguageSelect = document.getElementById('testLanguage');
const testResults = document.getElementById('testResults');
const resultsTitle = document.getElementById('resultsTitle');
const resultsContent = document.getElementById('resultsContent');
const testStatus = document.getElementById('testStatus');
const charCount = document.getElementById('char-count');
const smsCount = document.getElementById('sms-count');

// Sender IDs by provider for filtering
const senderIdsByProvider = {{ senderIdsByProvider|json_encode|raw }};

// Providers with dev API key configured
const providersWithDevKey = {{ providersWithDevKey|json_encode|raw }};

// Provider API keys (masked)
const providerApiKeys = {{ providerApiKeys|json_encode|raw }};

// Provider allowed countries
const providerAllowedCountries = {{ providerAllowedCountries|json_encode|raw }};

// All dial codes from base helper
const allDialCodes = {{ allDialCodes|json_encode|raw }};

// API key info elements
const apiKeyInfo = document.getElementById('apiKeyInfo');
const apiKeyInfoMessage = document.getElementById('apiKeyInfoMessage');

// Current dial codes for selected provider (for auto-detect)
let currentDialCodes = [];

// Update country dropdown based on provider's allowed countries
function updateCountryDropdown() {
    const providerId = testProviderSelect.value;
    const allowedCountries = providerAllowedCountries[providerId] || [];
    const isAllCountries = allowedCountries.includes('*') || allowedCountries.length === 0;

    testCountrySelect.innerHTML = '';
    currentDialCodes = [];

    if (isAllCountries) {
        // All countries allowed
        allDialCodes.forEach(function(item) {
            const option = document.createElement('option');
            option.value = item.country;
            option.textContent = item.label;
            option.dataset.dialcode = item.dialCode;
            testCountrySelect.appendChild(option);
            currentDialCodes.push({ code: item.dialCode, country: item.country });
        });
    } else {
        // Limited to specific countries
        allowedCountries.forEach(function(countryCode) {
            const item = allDialCodes.find(d => d.country === countryCode);
            if (item) {
                const option = document.createElement('option');
                option.value = item.country;
                option.textContent = item.label;
                option.dataset.dialcode = item.dialCode;
                testCountrySelect.appendChild(option);
                currentDialCodes.push({ code: item.dialCode, country: item.country });
            }
        });
    }

    // Sort dial codes by length descending for auto-detect (longer codes first)
    currentDialCodes.sort((a, b) => b.code.length - a.code.length);
}

// Update API key info based on selected sender ID
function updateApiKeyInfo() {
    const providerId = testProviderSelect.value;
    const senderIdId = testSenderIdSelect.value;
    const senderIds = senderIdsByProvider[providerId] || [];
    const selectedSenderId = senderIds.find(s => s.id == senderIdId);
    const hasDevKey = providersWithDevKey[providerId] || false;
    const apiKeys = providerApiKeys[providerId] || { main: '', dev: '' };
    const allowedCountries = providerAllowedCountries[providerId] || [];

    if (selectedSenderId) {
        apiKeyInfo.style.display = 'block';
        let message = '';

        // API key info
        if (selectedSenderId.isDev) {
            if (hasDevKey) {
                message = '<strong>{{ 'Using Development API Key'|t('sms-manager') }}:</strong> <code>' + Craft.escapeHtml(apiKeys.dev) + '</code>';
            } else {
                message = '<strong>{{ 'Using Main API Key'|t('sms-manager') }}:</strong> <code>' + Craft.escapeHtml(apiKeys.main) + '</code> â€” {{ 'No development API key configured'|t('sms-manager') }}';
            }
        } else {
            message = '<strong>{{ 'Using Main API Key'|t('sms-manager') }}:</strong> <code>' + Craft.escapeHtml(apiKeys.main) + '</code>';
        }

        // Allowed countries info - build display names from allDialCodes
        if (allowedCountries.length > 0) {
            let countriesList;
            if (allowedCountries.includes('*')) {
                countriesList = '{{ 'All Countries'|t('sms-manager') }}';
            } else {
                countriesList = allowedCountries
                    .map(code => {
                        const item = allDialCodes.find(d => d.country === code);
                        return item ? item.label : code;
                    })
                    .join(', ');
            }
            message += '<br><strong>{{ 'Allowed Countries'|t('sms-manager') }}:</strong> ' + Craft.escapeHtml(countriesList);
        }

        apiKeyInfoMessage.innerHTML = message;
    } else {
        apiKeyInfo.style.display = 'none';
    }
}

// Update sender ID dropdown when provider changes
if (testProviderSelect) {
    testProviderSelect.addEventListener('change', function() {
        const providerId = this.value;
        const senderIds = senderIdsByProvider[providerId] || [];

        // Clear and rebuild sender ID options
        testSenderIdSelect.innerHTML = '';
        senderIds.forEach(function(senderId) {
            const option = document.createElement('option');
            option.value = senderId.id;
            option.textContent = senderId.name + (senderId.isDefault ? ' (Default)' : '') + (senderId.isDev ? ' [Dev]' : '');
            testSenderIdSelect.appendChild(option);
        });

        // Select default if available
        const defaultSenderId = senderIds.find(s => s.isDefault);
        if (defaultSenderId) {
            testSenderIdSelect.value = defaultSenderId.id;
        }

        // Update country dropdown
        updateCountryDropdown();

        // Update API key info
        updateApiKeyInfo();
    });
}

// Update API key info when sender ID changes
if (testSenderIdSelect) {
    testSenderIdSelect.addEventListener('change', updateApiKeyInfo);
}

// Initialize on page load
updateCountryDropdown();
updateApiKeyInfo();

// Detect and strip country code from pasted number
function detectAndStripCountryCode(value) {
    // Remove whitespace, +, and 00 prefix
    let cleaned = value.replace(/[\s\-\(\)]/g, '');
    if (cleaned.indexOf('+') === 0) {
        cleaned = cleaned.substring(1);
    }
    if (cleaned.indexOf('00') === 0) {
        cleaned = cleaned.substring(2);
    }

    // Try to match a dial code from our allowed list
    for (let i = 0; i < currentDialCodes.length; i++) {
        const item = currentDialCodes[i];
        if (cleaned.indexOf(item.code) === 0 && cleaned.length > item.code.length) {
            return {
                dialCode: item.code,
                countryCode: item.country,
                localNumber: cleaned.substring(item.code.length)
            };
        }
    }
    return null;
}

function processPhoneInput() {
    const value = testRecipientInput.value.trim();
    if (!value) return;

    const result = detectAndStripCountryCode(value);
    if (result && result.localNumber && result.countryCode) {
        testCountrySelect.value = result.countryCode;
        testRecipientInput.value = result.localNumber;
    }
}

// Sanitize phone number - remove invisible characters and formatting
function sanitizePhoneNumber(value) {
    // Remove zero-width spaces, non-breaking spaces, directional marks, BOM, etc.
    value = value.replace(/[\u200B-\u200D\uFEFF\u00A0\u2060\u202A-\u202E\u2066-\u2069]/g, '');
    // Keep only digits
    return value.replace(/[^0-9]/g, '');
}

// Phone input handlers - sanitize and auto-detect country code
if (testRecipientInput) {
    // Process on paste - detect country code
    testRecipientInput.addEventListener('paste', function(e) {
        setTimeout(() => {
            processPhoneInput();
            this.value = sanitizePhoneNumber(this.value);
        }, 10);
    });

    // Process on blur - detect country code
    testRecipientInput.addEventListener('blur', function() {
        processPhoneInput();
    });

    // Sanitize on input and auto-detect with debounce
    let inputTimeout;
    testRecipientInput.addEventListener('input', function() {
        const sanitized = sanitizePhoneNumber(this.value);
        if (sanitized !== this.value) {
            const cursorPos = this.selectionStart;
            const diff = this.value.length - sanitized.length;
            this.value = sanitized;
            this.setSelectionRange(Math.max(0, cursorPos - diff), Math.max(0, cursorPos - diff));
        }

        // Auto-detect country code with debounce for longer numbers
        clearTimeout(inputTimeout);
        inputTimeout = setTimeout(function() {
            if (testRecipientInput.value.length > 9) {
                processPhoneInput();
            }
        }, 500);
    });
}

// Get full phone number with country dial code
function getFullPhoneNumber() {
    const selectedOption = testCountrySelect.options[testCountrySelect.selectedIndex];
    const dialCode = selectedOption ? selectedOption.dataset.dialcode : '';
    const localNumber = sanitizePhoneNumber(testRecipientInput.value);
    return dialCode + localNumber;
}

// RTL languages
const rtlLanguages = ['ar', 'he', 'fa', 'ur'];

// Update text direction based on language
function updateTextDirection() {
    const lang = testLanguageSelect.value;
    const isRtl = rtlLanguages.includes(lang);
    testMessageInput.dir = isRtl ? 'rtl' : 'ltr';
    testMessageInput.style.textAlign = isRtl ? 'right' : 'left';
}

// Character counter
if (testMessageInput) {
    function updateCharCount() {
        const message = testMessageInput.value;
        const length = message.length;
        const lang = testLanguageSelect.value;
        const isRtl = rtlLanguages.includes(lang);

        charCount.textContent = length;

        // Calculate SMS parts (GSM-7: 160/153, UCS-2: 70/67 for RTL/Unicode)
        let singleLimit = isRtl ? 70 : 160;
        let multiLimit = isRtl ? 67 : 153;

        let parts = 1;
        if (length > singleLimit) {
            parts = Math.ceil(length / multiLimit);
        }
        smsCount.textContent = parts;
    }

    testMessageInput.addEventListener('input', updateCharCount);
    testLanguageSelect.addEventListener('change', function() {
        updateCharCount();
        updateTextDirection();
    });
    updateCharCount();
    updateTextDirection();
}

// Send test SMS
if (testButton) {
    testButton.addEventListener('click', function() {
        const providerId = testProviderSelect.value;
        const senderIdId = testSenderIdSelect.value;
        const localNumber = sanitizePhoneNumber(testRecipientInput.value);
        const recipient = getFullPhoneNumber();
        const message = testMessageInput.value.trim();
        const language = testLanguageSelect.value;

        // Validation
        if (!localNumber) {
            testResults.style.display = 'block';
            resultsTitle.innerHTML = '{{ "Validation Error"|t("sms-manager") }}';
            resultsTitle.style.color = '#dc2626';
            resultsContent.innerHTML = '<p style="color: #dc2626;">{{ "Please enter a recipient phone number"|t("sms-manager") }}</p>';
            return;
        }

        // Must contain at least some digits
        if (localNumber.length < 6) {
            testResults.style.display = 'block';
            resultsTitle.innerHTML = '{{ "Validation Error"|t("sms-manager") }}';
            resultsTitle.style.color = '#dc2626';
            resultsContent.innerHTML = '<p style="color: #dc2626;">{{ "Phone number must contain at least 6 digits."|t("sms-manager") }}</p>';
            return;
        }

        if (!message) {
            testResults.style.display = 'block';
            resultsTitle.innerHTML = '{{ "Validation Error"|t("sms-manager") }}';
            resultsTitle.style.color = '#dc2626';
            resultsContent.innerHTML = '<p style="color: #dc2626;">{{ "Please enter a message"|t("sms-manager") }}</p>';
            return;
        }

        testButton.disabled = true;
        testButton.textContent = '{{ "Sending..."|t("sms-manager") }}';
        testStatus.textContent = '';

        fetch('{{ actionUrl("sms-manager/settings/test-sms") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRF-Token': '{{ craft.app.request.csrfToken }}',
            },
            body: JSON.stringify({
                providerId: providerId,
                senderIdId: senderIdId,
                recipient: recipient,
                message: message,
                language: language
            })
        })
        .then(response => response.json())
        .then(data => {
            testButton.disabled = false;
            testButton.textContent = '{{ "Send Test SMS"|t("sms-manager") }}';

            testResults.style.display = 'block';

            if (data.success) {
                resultsTitle.innerHTML = '{{ "SMS Sent Successfully"|t("sms-manager") }}';
                resultsTitle.style.color = '#059669';

                resultsContent.innerHTML = `
<div style="padding: 16px; background: #f0fdf4; border-left: 4px solid #059669; margin-bottom: 20px; border-radius: 0 4px 4px 0;">
    <p style="margin: 0;"><strong>{{ 'The test SMS was sent successfully.'|t('sms-manager') }}</strong></p>
</div>
<dl style="display: grid; grid-template-columns: 200px 1fr; gap: 10px; margin: 20px 0;">
    <dt><strong>{{ 'Provider'|t('sms-manager') }}:</strong></dt>
    <dd>${Craft.escapeHtml(data.providerName)}</dd>

    <dt><strong>{{ 'Sender ID'|t('sms-manager') }}:</strong></dt>
    <dd>${Craft.escapeHtml(data.senderIdName)} (<code>${Craft.escapeHtml(data.senderIdValue)}</code>)</dd>

    <dt><strong>{{ 'Recipient'|t('sms-manager') }}:</strong></dt>
    <dd><code>${Craft.escapeHtml(data.recipient)}</code></dd>

    <dt><strong>{{ 'Message ID'|t('sms-manager') }}:</strong></dt>
    <dd><code>${data.messageId || 'N/A'}</code></dd>

    <dt><strong>{{ 'Execution Time'|t('sms-manager') }}:</strong></dt>
    <dd>${data.executionTime}ms</dd>
</dl>
${data.response ? `<details style="margin-top: 16px;"><summary style="cursor: pointer; color: #6b7280;">{{ 'Provider Response'|t('sms-manager') }}</summary><pre style="background: #f3f4f6; padding: 12px; border-radius: 4px; margin-top: 8px; overflow-x: auto; font-size: 12px;">${Craft.escapeHtml(data.response)}</pre></details>` : ''}
`;
            } else {
                resultsTitle.innerHTML = '{{ "SMS Sending Failed"|t("sms-manager") }}';
                resultsTitle.style.color = '#dc2626';

                resultsContent.innerHTML = `
<div style="padding: 16px; background: #fef2f2; border-left: 4px solid #dc2626; margin-bottom: 20px; border-radius: 0 4px 4px 0;">
    <p style="margin: 0;"><strong>{{ 'The test SMS failed to send.'|t('sms-manager') }}</strong></p>
    <p style="margin: 8px 0 0; color: #dc2626;">${Craft.escapeHtml(data.error || 'Unknown error')}</p>
</div>
<dl style="display: grid; grid-template-columns: 200px 1fr; gap: 10px; margin: 20px 0;">
    <dt><strong>{{ 'Provider'|t('sms-manager') }}:</strong></dt>
    <dd>${Craft.escapeHtml(data.providerName || 'Unknown')}</dd>

    <dt><strong>{{ 'Sender ID'|t('sms-manager') }}:</strong></dt>
    <dd>${Craft.escapeHtml(data.senderIdName || 'Unknown')}</dd>
</dl>
${data.response ? `<details style="margin-top: 16px;"><summary style="cursor: pointer; color: #6b7280;">{{ 'Provider Response'|t('sms-manager') }}</summary><pre style="background: #f3f4f6; padding: 12px; border-radius: 4px; margin-top: 8px; overflow-x: auto; font-size: 12px;">${Craft.escapeHtml(data.response)}</pre></details>` : ''}
`;
            }
        })
        .catch(error => {
            testButton.disabled = false;
            testButton.textContent = '{{ "Send Test SMS"|t("sms-manager") }}';

            testResults.style.display = 'block';
            resultsTitle.innerHTML = '{{ "Error"|t("sms-manager") }}';
            resultsTitle.style.color = '#dc2626';
            resultsContent.innerHTML = `<p style="color: #dc2626;">${error.message}</p>`;
        });
    });
}

// Enter key triggers send
if (testRecipientInput) {
    testRecipientInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            testButton.click();
        }
    });
}
{% endjs %}
