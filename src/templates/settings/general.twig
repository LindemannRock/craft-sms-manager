{% extends "sms-manager/_layouts/settings" %}
{% set title = "General Settings"|t('sms-manager') %}
{% set fullPageForm = true %}
{% set selectedSettingsItem = 'general' %}

{% set plugin = craft.app.plugins.getPlugin('sms-manager') %}
{% set crumbs = [
    {
        label: smsHelper.fullName|t('sms-manager'),
        url: url('sms-manager'),
    },
    {
        label: 'Settings'|t('sms-manager'),
        url: url('sms-manager/settings'),
    },
    {
        label: 'General'|t('sms-manager'),
        url: url('sms-manager/settings/general'),
    },
] %}

{% import "_includes/forms" as forms %}

{% block content %}
    <form method="post" accept-charset="UTF-8">
        {{ actionInput('sms-manager/settings/save') }}
        {{ csrfInput() }}
        {{ redirectInput('sms-manager/settings/general') }}
        {{ hiddenInput('section', 'general') }}

        <h2 style="margin-top: 0px;">{{ "General Settings"|t('sms-manager') }}</h2>

        {{ forms.textField({
            label: "Plugin Name"|t('sms-manager'),
            instructions: "The name of the plugin as it appears in the Control Panel menu"|t('sms-manager'),
            id: 'pluginName',
            name: 'settings[pluginName]',
            value: settings.pluginName,
            required: true,
            disabled: settings.isOverriddenByConfig('pluginName'),
            warning: settings.isOverriddenByConfig('pluginName') ?
                "This is being overridden by the <code>pluginName</code> setting in <code>config/sms-manager.php</code>."|t('sms-manager')|raw : null,
        }) }}

        {% set enabledProviders = craft.app.plugins.getPlugin('sms-manager').providers.getAllProviders(true) %}
        {% set enabledSenderIds = craft.app.plugins.getPlugin('sms-manager').senderIds.getAllSenderIds(true) %}

        {% if enabledProviders|length == 0 %}
            {% include 'lindemannrock-base/_components/info-box' with {
                type: 'notice',
                message: 'No enabled providers. <a href="' ~ url('sms-manager/providers/new') ~ '">Create a provider</a> to use as the default.'
            } %}
        {% else %}
            {% set providerOptions = [{ label: 'Select a default provider...', value: '' }] %}
            {% for provider in enabledProviders %}
                {% set providerOptions = providerOptions|merge([{
                    label: provider.name ~ ' (' ~ provider.type|upper ~ ')',
                    value: provider.handle
                }]) %}
            {% endfor %}

            {{ forms.selectField({
                label: 'Default Provider'|t('sms-manager'),
                instructions: 'The provider that will be used when no specific provider is specified.'|t('sms-manager'),
                id: 'defaultProviderHandle',
                name: 'settings[defaultProviderHandle]',
                value: settings.defaultProviderHandle,
                options: providerOptions,
                disabled: settings.isOverriddenByConfig('defaultProviderHandle'),
                warning: settings.isOverriddenByConfig('defaultProviderHandle') ?
                    "This is being overridden by the <code>defaultProviderHandle</code> setting in <code>config/sms-manager.php</code>."|t('sms-manager')|raw : null,
            }) }}
        {% endif %}

        {% if enabledSenderIds|length == 0 %}
            {% include 'lindemannrock-base/_components/info-box' with {
                type: 'notice',
                message: 'No enabled sender IDs. <a href="' ~ url('sms-manager/sender-ids/new') ~ '">Create a sender ID</a> to use as the default.'
            } %}
        {% else %}
            {% set senderIdOptions = [{ label: 'Select a default sender ID...', value: '' }] %}
            {% for senderId in enabledSenderIds %}
                {% set senderIdOptions = senderIdOptions|merge([{
                    label: senderId.name ~ ' (' ~ senderId.senderId ~ ')',
                    value: senderId.handle
                }]) %}
            {% endfor %}

            {{ forms.selectField({
                label: 'Default Sender ID'|t('sms-manager'),
                instructions: 'The sender ID that will be used when no specific sender ID is specified.'|t('sms-manager'),
                id: 'defaultSenderIdHandle',
                name: 'settings[defaultSenderIdHandle]',
                value: settings.defaultSenderIdHandle,
                options: senderIdOptions,
                disabled: settings.isOverriddenByConfig('defaultSenderIdHandle'),
                warning: settings.isOverriddenByConfig('defaultSenderIdHandle') ?
                    "This is being overridden by the <code>defaultSenderIdHandle</code> setting in <code>config/sms-manager.php</code>."|t('sms-manager')|raw : null,
            }) }}
        {% endif %}

        <hr>

        <h2>{{ "Logging Settings"|t('sms-manager') }}</h2>

        {% set logOptions = [
            {value: 'error', label: 'Error (Critical errors only)'|t('sms-manager')},
            {value: 'warning', label: 'Warning (Errors and warnings)'|t('sms-manager')},
            {value: 'info', label: 'Info (General information)'|t('sms-manager')},
        ] %}

        {% if craft.app.config.general.devMode %}
            {% set logOptions = logOptions|merge([
                {value: 'debug', label: 'Debug (Detailed debugging)'|t('sms-manager')}
            ]) %}
        {% endif %}

        {{ forms.selectField({
            label: 'Log Level'|t('sms-manager'),
            instructions: 'Choose what types of messages to log. Debug level requires devMode to be enabled.'|t('sms-manager'),
            id: 'logLevel',
            name: 'settings[logLevel]',
            value: settings.logLevel,
            options: logOptions,
            disabled: settings.isOverriddenByConfig('logLevel'),
            warning: settings.isOverriddenByConfig('logLevel') ?
                "This is being overridden by the <code>logLevel</code> setting in <code>config/sms-manager.php</code>."|t('sms-manager')|raw : null,
        }) }}

        <div class="buttons">
            <button type="submit" class="btn submit">{{ "Save Settings"|t('sms-manager') }}</button>
        </div>
    </form>

    {% include 'lindemannrock-base/_components/plugin-credit' %}
{% endblock %}
