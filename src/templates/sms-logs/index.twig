{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set plugin = craft.app.plugins.getPlugin('sms-manager') %}

{% set title = 'SMS Logs'|t('sms-manager') %}
{% set fullPageForm = false %}
{% set selectedSubnavItem = 'sms-logs' %}

{% set canDownload = currentUser.can('smsManager:downloadLogs') %}

{% set crumbs = [
    { label: smsHelper.fullName, url: url('sms-manager') },
    { label: 'SMS Logs'|t('sms-manager'), url: url('sms-manager/sms-logs') }
] %}

{# Build language options from Craft sites #}
{% set languageOptions = [] %}
{% set seenLanguages = [] %}
{% for site in craft.app.sites.getAllSites() %}
    {% set langCode = site.language|split('-')|first %}
    {% if langCode not in seenLanguages %}
        {% set seenLanguages = seenLanguages|merge([langCode]) %}
        {% set languageOptions = languageOptions|merge([{
            code: langCode,
            label: site.language ~ ' (' ~ site.name ~ ')'
        }]) %}
    {% endif %}
{% endfor %}

{# Status colors #}
{% set statusColors = {
    'sent': { bg: 'rgba(16, 185, 129, 0.12)', text: '#059669' },
    'delivered': { bg: 'rgba(16, 185, 129, 0.12)', text: '#059669' },
    'failed': { bg: 'rgba(239, 68, 68, 0.12)', text: '#dc2626' },
    'pending': { bg: 'rgba(245, 158, 11, 0.12)', text: '#d97706' },
} %}

{% block toolbar %}
    <div id="toolbar" class="flex" style="align-items: flex-end;">
        <div class="flex-grow">
            <form method="get" action="{{ url('sms-manager/sms-logs') }}">
                <div class="flex">
                    {# Status filter #}
                    <div class="btngroup">
                        <button type="button" class="btn menubtn statusmenubtn">
                            <span class="status {{ statusFilter == 'all' ? 'all' : (statusFilter == 'sent' ? 'green' : (statusFilter == 'failed' ? 'red' : 'orange')) }}"></span>
                            {{ statusFilter == 'all' ? 'All Status'|t('sms-manager') : statusFilter|capitalize }}
                        </button>
                        <div class="menu">
                            <ul>
                                <li><a class="{{ statusFilter == 'all' ? 'sel' : '' }}" href="?status=all&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ sourceFilter }}&dateRange={{ dateRange }}&search={{ search }}&sort={{ sort }}&dir={{ dir }}"><span class="status all"></span>{{ 'All'|t('sms-manager') }}</a></li>
                                <li><a class="{{ statusFilter == 'sent' ? 'sel' : '' }}" href="?status=sent&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ sourceFilter }}&dateRange={{ dateRange }}&search={{ search }}&sort={{ sort }}&dir={{ dir }}"><span class="status green"></span>{{ 'Sent'|t('sms-manager') }}</a></li>
                                <li><a class="{{ statusFilter == 'delivered' ? 'sel' : '' }}" href="?status=delivered&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ sourceFilter }}&dateRange={{ dateRange }}&search={{ search }}&sort={{ sort }}&dir={{ dir }}"><span class="status green"></span>{{ 'Delivered'|t('sms-manager') }}</a></li>
                                <li><a class="{{ statusFilter == 'failed' ? 'sel' : '' }}" href="?status=failed&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ sourceFilter }}&dateRange={{ dateRange }}&search={{ search }}&sort={{ sort }}&dir={{ dir }}"><span class="status red"></span>{{ 'Failed'|t('sms-manager') }}</a></li>
                                <li><a class="{{ statusFilter == 'pending' ? 'sel' : '' }}" href="?status=pending&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ sourceFilter }}&dateRange={{ dateRange }}&search={{ search }}&sort={{ sort }}&dir={{ dir }}"><span class="status orange"></span>{{ 'Pending'|t('sms-manager') }}</a></li>
                            </ul>
                        </div>
                    </div>

                    {# Language filter - dynamic from Craft sites #}
                    {% set currentLangLabel = 'All Languages'|t('sms-manager') %}
                    {% if languageFilter != 'all' %}
                        {% for lang in languageOptions %}
                            {% if lang.code == languageFilter %}
                                {% set currentLangLabel = lang.label %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    <div class="btngroup">
                        <button type="button" class="btn menubtn">
                            {{ currentLangLabel }}
                        </button>
                        <div class="menu">
                            <ul>
                                <li><a class="{{ languageFilter == 'all' ? 'sel' : '' }}" href="?status={{ statusFilter }}&provider={{ providerFilter }}&language=all&source={{ sourceFilter }}&dateRange={{ dateRange }}&search={{ search }}&sort={{ sort }}&dir={{ dir }}">{{ 'All Languages'|t('sms-manager') }}</a></li>
                                {% for lang in languageOptions %}
                                    <li><a class="{{ languageFilter == lang.code ? 'sel' : '' }}" href="?status={{ statusFilter }}&provider={{ providerFilter }}&language={{ lang.code }}&source={{ sourceFilter }}&dateRange={{ dateRange }}&search={{ search }}&sort={{ sort }}&dir={{ dir }}">{{ lang.label }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    {# Source filter #}
                    {% set currentSourceLabel = 'All Sources'|t('sms-manager') %}
                    {% if sourceFilter == 'direct' %}
                        {% set currentSourceLabel = 'Direct'|t('sms-manager') %}
                    {% elseif sourceFilter != 'all' %}
                        {% set currentSourceLabel = sourceFilter %}
                    {% endif %}
                    <div class="btngroup">
                        <button type="button" class="btn menubtn">
                            {{ currentSourceLabel }}
                        </button>
                        <div class="menu">
                            <ul>
                                <li><a class="{{ sourceFilter == 'all' ? 'sel' : '' }}" href="?status={{ statusFilter }}&provider={{ providerFilter }}&language={{ languageFilter }}&source=all&dateRange={{ dateRange }}&search={{ search }}&sort={{ sort }}&dir={{ dir }}">{{ 'All Sources'|t('sms-manager') }}</a></li>
                                <li><a class="{{ sourceFilter == 'direct' ? 'sel' : '' }}" href="?status={{ statusFilter }}&provider={{ providerFilter }}&language={{ languageFilter }}&source=direct&dateRange={{ dateRange }}&search={{ search }}&sort={{ sort }}&dir={{ dir }}">{{ 'Direct'|t('sms-manager') }}</a></li>
                                {% for source in sources %}
                                    <li><a class="{{ sourceFilter == source ? 'sel' : '' }}" href="?status={{ statusFilter }}&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ source }}&dateRange={{ dateRange }}&search={{ search }}&sort={{ sort }}&dir={{ dir }}">{{ source }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    {# Date range filter #}
                    {% set dateRangeLabels = {
                        'today': 'Today'|t('sms-manager'),
                        'yesterday': 'Yesterday'|t('sms-manager'),
                        'last7days': 'Last 7 days'|t('sms-manager'),
                        'last30days': 'Last 30 days'|t('sms-manager'),
                        'last90days': 'Last 90 days'|t('sms-manager'),
                        'all': 'All time'|t('sms-manager'),
                    } %}
                    <div class="btngroup">
                        <button type="button" class="btn menubtn">
                            {{ dateRangeLabels[dateRange] ?? dateRangeLabels['last30days'] }}
                        </button>
                        <div class="menu">
                            <ul>
                                <li><a class="{{ dateRange == 'today' ? 'sel' : '' }}" href="?status={{ statusFilter }}&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ sourceFilter }}&dateRange=today&search={{ search }}&sort={{ sort }}&dir={{ dir }}">{{ 'Today'|t('sms-manager') }}</a></li>
                                <li><a class="{{ dateRange == 'yesterday' ? 'sel' : '' }}" href="?status={{ statusFilter }}&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ sourceFilter }}&dateRange=yesterday&search={{ search }}&sort={{ sort }}&dir={{ dir }}">{{ 'Yesterday'|t('sms-manager') }}</a></li>
                                <li><a class="{{ dateRange == 'last7days' ? 'sel' : '' }}" href="?status={{ statusFilter }}&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ sourceFilter }}&dateRange=last7days&search={{ search }}&sort={{ sort }}&dir={{ dir }}">{{ 'Last 7 days'|t('sms-manager') }}</a></li>
                                <li><a class="{{ dateRange == 'last30days' ? 'sel' : '' }}" href="?status={{ statusFilter }}&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ sourceFilter }}&dateRange=last30days&search={{ search }}&sort={{ sort }}&dir={{ dir }}">{{ 'Last 30 days'|t('sms-manager') }}</a></li>
                                <li><a class="{{ dateRange == 'last90days' ? 'sel' : '' }}" href="?status={{ statusFilter }}&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ sourceFilter }}&dateRange=last90days&search={{ search }}&sort={{ sort }}&dir={{ dir }}">{{ 'Last 90 days'|t('sms-manager') }}</a></li>
                                <li><a class="{{ dateRange == 'all' ? 'sel' : '' }}" href="?status={{ statusFilter }}&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ sourceFilter }}&dateRange=all&search={{ search }}&sort={{ sort }}&dir={{ dir }}">{{ 'All time'|t('sms-manager') }}</a></li>
                            </ul>
                        </div>
                    </div>

                    {# Search #}
                    <div class="search-container texticon flex-grow">
                        <span class="texticon-icon search icon" aria-hidden="true"></span>
                        <input type="text" class="clearable text fullwidth" name="search" value="{{ search }}" placeholder="{{ 'Search logs...'|t('sms-manager') }}" autocomplete="off">
                        <button type="button" class="clear-btn {{ search ? '' : 'hidden' }}" title="{{ 'Clear'|t('app') }}"></button>
                        <input type="hidden" name="status" value="{{ statusFilter }}">
                        <input type="hidden" name="provider" value="{{ providerFilter }}">
                        <input type="hidden" name="language" value="{{ languageFilter }}">
                        <input type="hidden" name="source" value="{{ sourceFilter }}">
                        <input type="hidden" name="dateRange" value="{{ dateRange }}">
                        <input type="hidden" name="sort" value="{{ sort }}">
                        <input type="hidden" name="dir" value="{{ dir }}">
                    </div>
                </div>
            </form>
        </div>
        {% if canDownload %}
            <div class="btngroup">
                <button type="button" class="btn menubtn" data-icon="download">{{ "Export"|t('sms-manager') }}</button>
                <div class="menu" data-align="right">
                    <ul>
                        <li>
                            <a href="{{ url('sms-manager/sms-logs/export', {dateRange: dateRange, format: 'csv'}) }}">{{ "Export as CSV"|t('sms-manager') }}</a>
                        </li>
                        <li>
                            <a href="{{ url('sms-manager/sms-logs/export', {dateRange: dateRange, format: 'json'}) }}">{{ "Export as JSON"|t('sms-manager') }}</a>
                        </li>
                    </ul>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block content %}
    <style>
        .log-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
        }
        .message-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .pagination {
            gap: 4px;
            align-items: center;
        }
        .page-info {
            margin: 0 12px;
            color: #596673;
        }
        /* Clickable row hover effect */
        .clickable-row {
            cursor: pointer;
            transition: background 0.1s ease;
        }
        .clickable-row:hover {
            background: #f9fafb !important;
        }
        /* Context row styling */
        .context-row td {
            padding: 0 !important;
        }
        .context-row .context-content {
            padding: 16px;
            background: #f9fafb;
            border-left: 3px solid #3498db;
        }
        .context-row.error .context-content {
            border-left-color: #ef4444;
        }
        .context-label {
            font-size: 11px;
            color: #606d7b;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .context-value {
            font-family: Monaco, 'Courier New', monospace;
            font-size: 12px;
            background: #ffffff;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            padding: 8px 12px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .context-grid {
            display: grid;
            gap: 12px;
        }
    </style>

    <div id="elements" class="elements">
        <div class="tableview tablepane">
            <table class="data fullwidth">
                <thead>
                    <tr>
                        <th scope="col" data-attribute="dateCreated" class="orderable {{ sort == 'dateCreated' ? 'ordered ' ~ dir : '' }}">
                            <button type="button" data-sort="dateCreated">{{ 'Date'|t('sms-manager') }}</button>
                        </th>
                        <th scope="col" data-attribute="recipient" class="orderable {{ sort == 'recipient' ? 'ordered ' ~ dir : '' }}">
                            <button type="button" data-sort="recipient">{{ 'Recipient'|t('sms-manager') }}</button>
                        </th>
                        <th scope="col">{{ 'Message'|t('sms-manager') }}</th>
                        <th scope="col" data-attribute="language" class="orderable {{ sort == 'language' ? 'ordered ' ~ dir : '' }}">
                            <button type="button" data-sort="language">{{ 'Language'|t('sms-manager') }}</button>
                        </th>
                        <th scope="col" data-attribute="status" class="orderable {{ sort == 'status' ? 'ordered ' ~ dir : '' }}">
                            <button type="button" data-sort="status">{{ 'Status'|t('sms-manager') }}</button>
                        </th>
                        <th scope="col">{{ 'Provider'|t('sms-manager') }}</th>
                        <th scope="col">{{ 'Sender ID'|t('sms-manager') }}</th>
                        <th scope="col">{{ 'Source'|t('sms-manager') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% if logs|length %}
                        {% for log in logs %}
                            {% set colors = statusColors[log.status] ?? { bg: '#f3f4f6', text: '#6b7280' } %}
                            {% set hasDetails = log.errorMessage or log.providerResponse or (log.message|length > 50) %}
                            {# Main log row - clickable #}
                            <tr class="clickable-row" data-id="{{ log.id }}" data-entry-id="{{ loop.index }}">
                                <td class="light">{{ (log.dateCreated ~ ' UTC')|date('M j, H:i', craft.app.timezone) }}</td>
                                <td><code>{{ log.recipient }}</code></td>
                                <td class="message-cell" title="{{ log.message }}">
                                    {{ log.message|slice(0, 50) }}{% if log.message|length > 50 %}...{% endif %}
                                </td>
                                <td>
                                    {% set langLabel = log.language %}
                                    {% for lang in languageOptions %}
                                        {% if lang.code == log.language %}
                                            {% set langLabel = lang.label %}
                                        {% endif %}
                                    {% endfor %}
                                    <span class="light">{{ langLabel }}</span>
                                </td>
                                <td>
                                    <span class="log-status" style="background: {{ colors.bg }}; color: {{ colors.text }};">
                                        {{ log.status|capitalize }}
                                    </span>
                                </td>
                                <td><span class="light">{{ log.providerName }}</span></td>
                                <td><span class="light">{{ log.senderIdName }}</span></td>
                                <td>
                                    {% if log.sourcePlugin %}
                                        <span class="light">{{ log.sourcePlugin }}</span>
                                    {% else %}
                                        <span class="light">{{ 'Direct'|t('sms-manager') }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {# Expandable context row - hidden by default #}
                            {% if hasDetails %}
                                <tr class="context-row {{ log.status == 'failed' ? 'error' : '' }}" data-entry-id="{{ loop.index }}" style="display: none;">
                                    <td colspan="8">
                                        <div class="context-content">
                                            <div class="context-grid">
                                                {# Full message #}
                                                <div>
                                                    <div class="context-label">{{ 'Full Message'|t('sms-manager') }}</div>
                                                    <div class="context-value">{{ log.message }}</div>
                                                </div>
                                                {# Error message (if failed) #}
                                                {% if log.errorMessage %}
                                                    <div>
                                                        <div class="context-label" style="color: #dc2626;">{{ 'Error'|t('sms-manager') }}</div>
                                                        <div class="context-value" style="border-color: #fecaca; background: #fef2f2;">{{ log.errorMessage }}</div>
                                                    </div>
                                                {% endif %}
                                                {# Provider response #}
                                                {% if log.providerResponse %}
                                                    <div>
                                                        <div class="context-label">{{ 'Provider Response'|t('sms-manager') }}</div>
                                                        <div class="context-value">{{ log.providerResponse }}</div>
                                                    </div>
                                                {% endif %}
                                                {# Provider Message ID #}
                                                {% if log.providerMessageId %}
                                                    <div>
                                                        <div class="context-label">{{ 'Message ID'|t('sms-manager') }}</div>
                                                        <div class="context-value">{{ log.providerMessageId }}</div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 2em;">
                                {{ 'No logs found.'|t('sms-manager') }}
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    {# Pagination #}
    <div id="footer" class="flex">
        <div class="light">
            <div class="flex pagination">
                <nav class="flex" aria-label="log pagination">
                    <button type="button" class="page-link prev-page {{ page <= 1 ? 'disabled' : '' }}" {{ page <= 1 ? 'disabled' : '' }} title="{{ 'Previous Page'|t('app') }}"></button>
                    <button type="button" class="page-link next-page {{ page >= totalPages ? 'disabled' : '' }}" {{ page >= totalPages ? 'disabled' : '' }} title="{{ 'Next Page'|t('app') }}"></button>
                </nav>
                <div class="page-info">
                    {% set endRange = min(offset + limit, totalCount) %}
                    {% if totalCount == 0 %}
                        {{ 'no logs'|t('sms-manager') }}
                    {% else %}
                        {{ offset + 1 }} â€“ {{ endRange }} {{ 'of'|t('app') }} {{ totalCount }} {{ 'logs'|t('sms-manager') }}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize menu buttons
        document.querySelectorAll('.menubtn').forEach(btn => {
            if (typeof Craft !== 'undefined' && Craft.MenuBtn) {
                new Craft.MenuBtn(btn);
            }
        });

        // Clickable rows to toggle context/details
        document.querySelectorAll('.clickable-row').forEach(row => {
            row.addEventListener('click', function(e) {
                // Don't toggle if clicking on a link or button
                if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }

                const entryId = this.dataset.entryId;
                const contextRow = document.querySelector('.context-row[data-entry-id="' + entryId + '"]');

                if (contextRow) {
                    const isVisible = contextRow.style.display !== 'none';
                    contextRow.style.display = isVisible ? 'none' : 'table-row';

                    // Toggle visual indicator on main row
                    if (!isVisible) {
                        this.style.background = '#f0f4f8';
                    } else {
                        this.style.background = '';
                    }
                }
            });
        });

        // Clear search
        const searchClearBtn = document.querySelector('.search-container .clear-btn');
        if (searchClearBtn) {
            searchClearBtn.addEventListener('click', function() {
                const searchInput = this.previousElementSibling;
                searchInput.value = '';
                searchInput.form.submit();
            });
        }

        // Search on Enter
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput) {
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    this.form.submit();
                }
            });
        }

        // Sort buttons
        document.querySelectorAll('th.orderable button').forEach(button => {
            button.addEventListener('click', function() {
                const sortField = this.dataset.sort;
                const currentSort = '{{ sort }}';
                const currentDir = '{{ dir }}';
                let newDir = 'asc';

                if (sortField === currentSort) {
                    newDir = currentDir === 'asc' ? 'desc' : 'asc';
                }

                window.location.href = '?status={{ statusFilter }}&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ sourceFilter }}&dateRange={{ dateRange }}&search={{ search }}&sort=' + sortField + '&dir=' + newDir + '&page=1';
            });
        });

        // Pagination
        document.querySelector('.prev-page:not(.disabled)')?.addEventListener('click', function() {
            window.location.href = '?status={{ statusFilter }}&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ sourceFilter }}&dateRange={{ dateRange }}&search={{ search }}&sort={{ sort }}&dir={{ dir }}&page={{ page - 1 }}';
        });

        document.querySelector('.next-page:not(.disabled)')?.addEventListener('click', function() {
            window.location.href = '?status={{ statusFilter }}&provider={{ providerFilter }}&language={{ languageFilter }}&source={{ sourceFilter }}&dateRange={{ dateRange }}&search={{ search }}&sort={{ sort }}&dir={{ dir }}&page={{ page + 1 }}';
        });
    </script>
{% endblock %}
