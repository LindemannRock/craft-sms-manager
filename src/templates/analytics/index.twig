{#
 # SMS Analytics Dashboard
 #
 # Uses the centralized cp-analytics layout from base plugin.
 #}

{% extends 'lindemannrock-base/_layouts/cp-analytics' %}

{# Encoding labels for SMS character encoding #}
{% set encodingLabels = {
    'gsm7': 'GSM-7 (Latin)'|t('sms-manager'),
    'ucs2': 'UCS-2 (Unicode)'|t('sms-manager'),
    'mixed': 'Mixed'|t('sms-manager')
} %}

{# ============================================================================
   ANALYTICS CONFIGURATION
   ============================================================================ #}

{% set analyticsConfig = {
    plugin: {
        handle: 'sms-manager',
        name: smsHelper.fullName,
    },
    page: {
        title: 'Analytics'|t('sms-manager'),
        subnav: 'analytics',
        crumbs: [
            { label: smsHelper.fullName, url: url('sms-manager') },
            { label: 'Analytics'|t('sms-manager'), url: url('sms-manager/analytics') },
        ],
    },
    tabs: {
        overview: { label: 'Overview'|t('sms-manager') },
        senderids: { label: 'Sender IDs'|t('sms-manager') },
        encoding: { label: 'Encoding'|t('sms-manager') },
    },
    filters: {
        dateRange: {
            default: 'last7days',
            current: dateRange,
        },
    },
    export: {
        permission: 'smsManager:exportAnalytics',
        action: 'sms-manager/analytics/export',
    },
    charts: {
        prefix: 'sms',
        dataEndpoint: 'sms-manager/analytics/get-data',
    },
} %}


{# ============================================================================
   TAB CONTENT
   ============================================================================ #}

{% block tabs %}
    {# Overview Tab #}
    <div id="overview" class="lr-tab-content">
        {% include 'sms-manager/analytics/_partials/overview' %}
    </div>

    {# Sender IDs Tab #}
    <div id="senderids" class="lr-tab-content hidden">
        {% include 'sms-manager/analytics/_partials/senderids' %}
    </div>

    {# Encoding Tab #}
    <div id="encoding" class="lr-tab-content hidden">
        {% include 'sms-manager/analytics/_partials/encoding' %}
    </div>
{% endblock %}


{# ============================================================================
   CHART INITIALIZATION
   ============================================================================ #}

{% block scripts %}
<script>
(function() {
    'use strict';

    // Chart colors
    const chartColors = window.lrChartColors || [
        '#0d78f2', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#06b6d4',
        '#ec4899', '#84cc16', '#f97316', '#6366f1'
    ];

    // Encoding labels
    const encodingLabels = {
        gsm7: '{{ encodingLabels.gsm7|e('js') }}',
        ucs2: '{{ encodingLabels.ucs2|e('js') }}',
        mixed: '{{ encodingLabels.mixed|e('js') }}'
    };

    // Initialize on analytics init event
    document.addEventListener('lr:analyticsInit', function(e) {
        loadAllChartData();
    });

    // Load all chart data
    function loadAllChartData() {
        // Daily trend chart
        window.lrLoadChartData('daily', function(data) {
            renderDailyChart(data);
        });

        // Provider chart
        window.lrLoadChartData('providers', function(data) {
            if (data && data.labels && data.labels.length > 0) {
                renderProviderChart(data);
            }
        });

        // Language chart
        window.lrLoadChartData('languages', function(data) {
            if (data && data.labels) {
                renderLanguageChart(data);
            }
        });

        // Sender ID chart
        window.lrLoadChartData('senderids', function(data) {
            if (data && data.labels && data.labels.length > 0) {
                renderSenderIdCharts(data);
            }
        });

        // Encoding distribution
        window.lrLoadChartData('encoding', function(data) {
            if (data && data.labels) {
                renderEncodingPieChart(data);
            }
        });

        // Encoding daily
        window.lrLoadChartData('encoding-daily', function(data) {
            if (data) {
                renderEncodingDailyChart(data);
            }
        });
    }

    // Chart rendering functions
    function renderDailyChart(data) {
        window.lrCreateChart('daily-trend-chart', 'line', {
            labels: data.labels,
            datasets: [
                {
                    label: '{{ "Sent"|t('sms-manager')|e('js') }}',
                    data: data.sent,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: '{{ "Failed"|t('sms-manager')|e('js') }}',
                    data: data.failed,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.3,
                    fill: true
                }
            ]
        }, {
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } }
        });
    }

    function renderProviderChart(data) {
        window.lrCreateChart('provider-chart', 'doughnut', {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: chartColors.slice(0, data.labels.length)
            }]
        });
    }

    function renderLanguageChart(data) {
        window.lrCreateChart('language-chart', 'doughnut', {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: chartColors.slice(0, data.labels.length)
            }]
        });
    }

    function renderEncodingPieChart(data) {
        window.lrCreateChart('encoding-pie-chart', 'pie', {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: ['#3b82f6', '#8b5cf6', '#6b7280']
            }]
        });
    }

    function renderEncodingDailyChart(data) {
        window.lrCreateChart('encoding-daily-chart', 'bar', {
            labels: data.labels,
            datasets: [
                {
                    label: encodingLabels.gsm7,
                    data: data.gsm7,
                    backgroundColor: '#3b82f6'
                },
                {
                    label: encodingLabels.ucs2,
                    data: data.ucs2,
                    backgroundColor: '#8b5cf6'
                },
                {
                    label: encodingLabels.mixed,
                    data: data.mixed,
                    backgroundColor: '#6b7280'
                }
            ]
        }, {
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
            }
        });
    }

    function renderSenderIdCharts(data) {
        // Bar chart
        window.lrCreateChart('senderid-bar-chart', 'bar', {
            labels: data.labels,
            datasets: [
                {
                    label: '{{ "Sent"|t('sms-manager')|e('js') }}',
                    data: data.sent,
                    backgroundColor: '#10b981'
                },
                {
                    label: '{{ "Failed"|t('sms-manager')|e('js') }}',
                    data: data.failed,
                    backgroundColor: '#ef4444'
                }
            ]
        }, {
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } }
        });

        // Pie chart
        const totals = data.sent.map((s, i) => s + data.failed[i]);
        window.lrCreateChart('senderid-pie-chart', 'doughnut', {
            labels: data.labels,
            datasets: [{
                data: totals,
                backgroundColor: chartColors.slice(0, data.labels.length)
            }]
        });

        // Success rate chart
        const rates = data.sent.map((s, i) => {
            const total = s + data.failed[i];
            return total > 0 ? Math.round((s / total) * 100) : 0;
        });
        window.lrCreateChart('senderid-success-chart', 'bar', {
            labels: data.labels,
            datasets: [{
                label: '{{ "Success Rate %"|t('sms-manager')|e('js') }}',
                data: rates,
                backgroundColor: rates.map(r => r >= 90 ? '#10b981' : (r >= 70 ? '#f59e0b' : '#ef4444'))
            }]
        }, {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, max: 100 } }
        });
    }
})();
</script>
{% endblock %}
