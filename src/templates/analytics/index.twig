{% extends "_layouts/cp" %}
{% set title = "Analytics"|t('sms-manager') %}
{% set selectedSubnavItem = 'analytics' %}

{% set crumbs = [
    {
        label: smsHelper.fullName|t('sms-manager'),
        url: url('sms-manager'),
    },
    {
        label: 'Analytics'|t('sms-manager'),
        url: url('sms-manager/analytics'),
    },
] %}

{# Encoding labels for SMS character encoding #}
{% set encodingLabels = {
    'gsm7': 'GSM-7 (Latin)'|t('sms-manager'),
    'ucs2': 'UCS-2 (Unicode)'|t('sms-manager'),
    'mixed': 'Mixed'|t('sms-manager')
} %}

{# Permission checks #}
{% set canExport = currentUser.can('smsManager:exportAnalytics') %}

{# Define Tabs #}
{% set tabs = {
    overview: { label: "Overview"|t('sms-manager'), url: '#overview' },
    senderids: { label: "Sender IDs"|t('sms-manager'), url: '#senderids' },
    encoding: { label: "Encoding"|t('sms-manager'), url: '#encoding' },
} %}

{% set selectedTab = 'overview' %}

{% block actionButton %}
    {% if canExport %}
        <div id="action-button" class="btngroup">
            <button type="button" class="btn menubtn" data-icon="download">{{ "Export"|t('sms-manager') }}</button>
            <div class="menu" data-align="right">
                <ul>
                    <li>
                        <a href="#" class="export-link" data-format="csv">{{ "Export as CSV"|t('sms-manager') }}</a>
                    </li>
                    <li>
                        <a href="#" class="export-link" data-format="json">{{ "Export as JSON"|t('sms-manager') }}</a>
                    </li>
                </ul>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block toolbar %}
    <div class="flex">
        {# Provider filter #}
        {% if providers|length > 1 %}
        <div>
            <div class="btngroup">
                <button type="button" class="btn menubtn">
                    <span id="providerLabel">{{ providerId == 'all' ? 'All Providers'|t('sms-manager') : providers|filter(p => p.id == providerId)|first.name }}</span>
                </button>
                <div class="menu">
                    <ul>
                        <li><a href="#" data-provider="all" class="provider-option {{ providerId == 'all' ? 'sel' : '' }}">{{ "All Providers"|t('sms-manager') }}</a></li>
                        {% for provider in providers %}
                            <li><a href="#" data-provider="{{ provider.id }}" class="provider-option {{ providerId == provider.id ? 'sel' : '' }}">{{ provider.name }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}

        {# Date range filter #}
        <div>
            <div class="btngroup">
                <button type="button" class="btn menubtn">
                    <span id="dateRangeLabel">{{ dateRange == 'today' ? 'Today' : (dateRange == 'yesterday' ? 'Yesterday' : (dateRange == 'last7days' ? 'Last 7 days' : (dateRange == 'last30days' ? 'Last 30 days' : (dateRange == 'last90days' ? 'Last 90 days' : 'All time')))) }}</span>
                </button>
                <div class="menu">
                    <ul>
                        <li><a href="#" data-range="today" class="date-range-option {{ dateRange == 'today' ? 'sel' : '' }}">{{ "Today"|t('sms-manager') }}</a></li>
                        <li><a href="#" data-range="yesterday" class="date-range-option {{ dateRange == 'yesterday' ? 'sel' : '' }}">{{ "Yesterday"|t('sms-manager') }}</a></li>
                        <li><a href="#" data-range="last7days" class="date-range-option {{ dateRange == 'last7days' ? 'sel' : '' }}">{{ "Last 7 days"|t('sms-manager') }}</a></li>
                        <li><a href="#" data-range="last30days" class="date-range-option {{ dateRange == 'last30days' ? 'sel' : '' }}">{{ "Last 30 days"|t('sms-manager') }}</a></li>
                        <li><a href="#" data-range="last90days" class="date-range-option {{ dateRange == 'last90days' ? 'sel' : '' }}">{{ "Last 90 days"|t('sms-manager') }}</a></li>
                        <li><a href="#" data-range="all" class="date-range-option {{ dateRange == 'all' ? 'sel' : '' }}">{{ "All time"|t('sms-manager') }}</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    {# Tab Content - IDs must match tab URLs #}
    <div id="overview" class="tab-content">
        {% include 'sms-manager/analytics/_partials/overview' %}
    </div>

    <div id="senderids" class="tab-content hidden">
        {% include 'sms-manager/analytics/_partials/senderids' %}
    </div>

    <div id="encoding" class="tab-content hidden">
        {% include 'sms-manager/analytics/_partials/encoding' %}
    </div>

    {% include 'lindemannrock-base/_components/plugin-credit' %}
{% endblock %}

{% css %}
/* Tab content padding */
.tab-content {
    padding: 24px;
}

.analytics-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.stat-box {
    background: #f3f7fc;
    padding: 24px;
    border-radius: 4px;
    text-align: center;
    border: 1px solid var(--hairline-color);
}

.stat-value {
    font-size: 32px;
    font-weight: 600;
    color: #0d78f2;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 14px;
    color: #596673;
}

.analytics-charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 30px;
    margin-bottom: 30px;
}

.analytics-charts.two-columns {
    grid-template-columns: repeat(2, 1fr);
}

@media (max-width: 1024px) {
    .analytics-charts.two-columns {
        grid-template-columns: 1fr;
    }
}

.chart-container.full-width {
    grid-column: 1 / -1;
}

.chart-container {
    background: #fff;
    border: 1px solid #e3e5e8;
    border-radius: 4px;
    padding: 24px;
    min-width: 0;
    overflow: hidden;
}

.chart-container h3 {
    margin: 0 0 20px;
    font-size: 16px;
}

.chart-container canvas {
    max-height: 300px;
    max-width: 100%;
}

.table-scroll-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0 -24px;
    padding: 0 24px;
}

.table-scroll-container table {
    min-width: 100%;
    width: 100%;
}
{% endcss %}

{% js %}
// Global chart instances
window.smsCharts = {};
window.currentTab = 'overview';

// Chart colors
const chartColors = [
    '#0d78f2', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#06b6d4',
    '#ec4899', '#84cc16', '#f97316', '#6366f1'
];

// Load Chart.js if not already loaded
if (typeof Chart === 'undefined') {
    var script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
    script.onload = function() { initCharts(); };
    document.head.appendChild(script);
} else {
    initCharts();
}

// Initialize charts with server-rendered data
function initCharts() {
    // Destroy existing charts
    Object.values(window.smsCharts).forEach(c => { if (c && c.destroy) c.destroy(); });
    window.smsCharts = {};

    // Get current parameters
    const urlParams = new URLSearchParams(window.location.search);
    const currentRange = urlParams.get('dateRange') || '{{ dateRange }}';
    const currentProvider = urlParams.get('provider') || 'all';

    // Load chart data
    loadAllChartData(currentRange, currentProvider);
}

// Load all chart data via AJAX
function loadAllChartData(dateRange, providerId) {
    const csrfToken = '{{ craft.app.request.csrfToken }}';
    const csrfName = '{{ craft.app.config.general.csrfTokenName }}';

    // Daily trend chart
    $.ajax({
        url: Craft.getActionUrl('sms-manager/analytics/get-data'),
        type: 'POST',
        dataType: 'json',
        data: { dateRange: dateRange, providerId: providerId, type: 'daily', [csrfName]: csrfToken },
        success: function(response) {
            if (response.success && response.data) {
                renderDailyChart(response.data);
            }
        }
    });

    // Provider chart
    $.ajax({
        url: Craft.getActionUrl('sms-manager/analytics/get-data'),
        type: 'POST',
        dataType: 'json',
        data: { dateRange: dateRange, providerId: providerId, type: 'providers', [csrfName]: csrfToken },
        success: function(response) {
            if (response.success && response.data && response.data.labels && response.data.labels.length > 0) {
                renderProviderChart(response.data);
            }
        }
    });

    // Language chart (overview - actual languages from logs)
    $.ajax({
        url: Craft.getActionUrl('sms-manager/analytics/get-data'),
        type: 'POST',
        dataType: 'json',
        data: { dateRange: dateRange, providerId: providerId, type: 'languages', [csrfName]: csrfToken },
        success: function(response) {
            if (response.success && response.data && response.data.labels) {
                renderLanguageChart(response.data);
            }
        }
    });

    // Sender ID chart
    $.ajax({
        url: Craft.getActionUrl('sms-manager/analytics/get-data'),
        type: 'POST',
        dataType: 'json',
        data: { dateRange: dateRange, providerId: providerId, type: 'senderids', [csrfName]: csrfToken },
        success: function(response) {
            if (response.success && response.data && response.data.labels && response.data.labels.length > 0) {
                renderSenderIdCharts(response.data);
            }
        }
    });

    // Encoding distribution chart (GSM-7 vs UCS-2)
    $.ajax({
        url: Craft.getActionUrl('sms-manager/analytics/get-data'),
        type: 'POST',
        dataType: 'json',
        data: { dateRange: dateRange, providerId: providerId, type: 'encoding', [csrfName]: csrfToken },
        success: function(response) {
            if (response.success && response.data && response.data.labels) {
                renderEncodingPieChart(response.data);
            }
        }
    });

    // Encoding daily chart
    $.ajax({
        url: Craft.getActionUrl('sms-manager/analytics/get-data'),
        type: 'POST',
        dataType: 'json',
        data: { dateRange: dateRange, providerId: providerId, type: 'encoding-daily', [csrfName]: csrfToken },
        success: function(response) {
            if (response.success && response.data) {
                renderEncodingDailyChart(response.data);
            }
        }
    });
}

// Chart rendering functions
function renderDailyChart(data) {
    const ctx = document.getElementById('daily-trend-chart');
    if (!ctx) return;

    if (window.smsCharts.daily) window.smsCharts.daily.destroy();

    window.smsCharts.daily = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [
                {
                    label: '{{ "Sent"|t('sms-manager') }}',
                    data: data.sent,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: '{{ "Failed"|t('sms-manager') }}',
                    data: data.failed,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } }
            }
        }
    });
}

function renderProviderChart(data) {
    const ctx = document.getElementById('provider-chart');
    if (!ctx) return;

    if (window.smsCharts.provider) window.smsCharts.provider.destroy();

    window.smsCharts.provider = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: chartColors.slice(0, data.labels.length)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });
}

function renderLanguageChart(data) {
    const ctx = document.getElementById('language-chart');
    if (!ctx) return;

    if (window.smsCharts.language) window.smsCharts.language.destroy();

    window.smsCharts.language = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: chartColors.slice(0, data.labels.length)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });
}

function renderEncodingPieChart(data) {
    const ctx = document.getElementById('encoding-pie-chart');
    if (!ctx) return;

    if (window.smsCharts.encodingPie) window.smsCharts.encodingPie.destroy();

    window.smsCharts.encodingPie = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: ['#3b82f6', '#8b5cf6', '#6b7280']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });
}

function renderEncodingDailyChart(data) {
    const ctx = document.getElementById('encoding-daily-chart');
    if (!ctx) return;

    if (window.smsCharts.encodingDaily) window.smsCharts.encodingDaily.destroy();

    window.smsCharts.encodingDaily = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [
                {
                    label: '{{ encodingLabels.gsm7 }}',
                    data: data.gsm7,
                    backgroundColor: '#3b82f6'
                },
                {
                    label: '{{ encodingLabels.ucs2 }}',
                    data: data.ucs2,
                    backgroundColor: '#8b5cf6'
                },
                {
                    label: '{{ encodingLabels.mixed }}',
                    data: data.mixed,
                    backgroundColor: '#6b7280'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
            }
        }
    });
}

function renderSenderIdCharts(data) {
    // Bar chart
    const barCtx = document.getElementById('senderid-bar-chart');
    if (barCtx) {
        if (window.smsCharts.senderidBar) window.smsCharts.senderidBar.destroy();

        window.smsCharts.senderidBar = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: '{{ "Sent"|t('sms-manager') }}',
                        data: data.sent,
                        backgroundColor: '#10b981'
                    },
                    {
                        label: '{{ "Failed"|t('sms-manager') }}',
                        data: data.failed,
                        backgroundColor: '#ef4444'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // Pie chart
    const pieCtx = document.getElementById('senderid-pie-chart');
    if (pieCtx) {
        if (window.smsCharts.senderidPie) window.smsCharts.senderidPie.destroy();

        const totals = data.sent.map((s, i) => s + data.failed[i]);
        window.smsCharts.senderidPie = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    data: totals,
                    backgroundColor: chartColors.slice(0, data.labels.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    // Success rate chart
    const successCtx = document.getElementById('senderid-success-chart');
    if (successCtx) {
        if (window.smsCharts.senderidSuccess) window.smsCharts.senderidSuccess.destroy();

        const rates = data.sent.map((s, i) => {
            const total = s + data.failed[i];
            return total > 0 ? Math.round((s / total) * 100) : 0;
        });

        window.smsCharts.senderidSuccess = new Chart(successCtx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '{{ "Success Rate %"|t('sms-manager') }}',
                    data: rates,
                    backgroundColor: rates.map(r => r >= 90 ? '#10b981' : (r >= 70 ? '#f59e0b' : '#ef4444'))
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, max: 100 } }
            }
        });
    }
}

// Tab Switching
function switchTab(tabId) {
    if (!tabId) tabId = 'overview';

    // Hide all tab content
    $('.tab-content').addClass('hidden');
    // Show selected tab content
    $('#' + tabId).removeClass('hidden');

    window.currentTab = tabId;
}

// Handle hash changes (when Craft switches tabs)
window.addEventListener('hashchange', function() {
    var hash = window.location.hash.substring(1);
    switchTab(hash);
});

// Document ready
$(document).ready(function() {
    // Handle clicks on tab links
    $(document).on('click', 'a[href^="#"]', function() {
        var href = $(this).attr('href');
        if (href && href.startsWith('#')) {
            setTimeout(function() {
                var hash = window.location.hash.substring(1);
                switchTab(hash);
            }, 10);
        }
    });

    // Handle initial tab
    var hash = window.location.hash.substring(1) || 'overview';
    switchTab(hash);

    // Date Range Handler - reload page
    $(document).on('click', '.date-range-option', function(e) {
        e.preventDefault();
        const range = $(this).data('range');
        const url = new URL(window.location);
        url.searchParams.set('dateRange', range);
        window.location = url;
    });

    // Provider Filter Handler - reload page
    $(document).on('click', '.provider-option', function(e) {
        e.preventDefault();
        const providerId = $(this).data('provider');
        const url = new URL(window.location);
        if (providerId && providerId !== 'all') {
            url.searchParams.set('provider', providerId);
        } else {
            url.searchParams.delete('provider');
        }
        window.location = url;
    });

    // Export Handler
    $(document).on('click', '.export-link', function(e) {
        e.preventDefault();
        const format = $(this).data('format') || 'csv';
        const dateRange = new URLSearchParams(window.location.search).get('dateRange') || 'last30days';

        const exportUrl = Craft.getActionUrl('sms-manager/analytics/export', {
            dateRange: dateRange,
            format: format
        });

        window.location.href = exportUrl;
    });
});
{% endjs %}
