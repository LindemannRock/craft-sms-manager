{#
 # Providers Index - Using cp-table layout
 #
 # This template extends the base plugin's cp-table layout to provide
 # a consistent interface for viewing SMS providers with filters, sorting,
 # and bulk actions.
 #}

{% extends 'lindemannrock-base/_layouts/cp-table' %}

{# ============================================================================
   PERMISSION CHECKS
   ============================================================================ #}

{% set canCreate = currentUser.can('smsManager:createProviders') %}
{% set canEdit = currentUser.can('smsManager:editProviders') %}
{% set canDelete = currentUser.can('smsManager:deleteProviders') %}

{# ============================================================================
   GET QUERY PARAMETERS
   ============================================================================ #}

{% set search = craft.app.request.getParam('search', '') %}
{% set statusFilter = craft.app.request.getParam('status', 'all') %}
{% set sourceFilter = craft.app.request.getParam('source', 'all') %}
{% set sort = craft.app.request.getParam('sort', 'name') %}
{% set dir = craft.app.request.getParam('dir', 'asc') %}
{% set page = craft.app.request.getParam('page', 1)|number_format(0, '', '') %}
{% set limit = settings.itemsPerPage ?? 50 %}
{% set offset = (page - 1) * limit %}

{# ============================================================================
   FILTER PROVIDERS (client-side filtering since data comes from service)
   ============================================================================ #}

{% set filteredProviders = providers %}

{# Status filter #}
{% if statusFilter == 'enabled' %}
    {% set filteredProviders = filteredProviders|filter(p => p.enabled) %}
{% elseif statusFilter == 'disabled' %}
    {% set filteredProviders = filteredProviders|filter(p => not p.enabled) %}
{% endif %}

{# Source filter #}
{% if sourceFilter == 'config' %}
    {% set filteredProviders = filteredProviders|filter(p => p.source == 'config') %}
{% elseif sourceFilter == 'database' %}
    {% set filteredProviders = filteredProviders|filter(p => p.source != 'config') %}
{% endif %}

{# Search filter #}
{% if search %}
    {% set filteredProviders = filteredProviders|filter(p => search|lower in p.name|lower or search|lower in p.handle|lower or search|lower in p.type|lower) %}
{% endif %}

{# Sort providers #}
{% if sort == 'name' %}
    {% set filteredProviders = filteredProviders|sort((a, b) => dir == 'asc' ? a.name|lower <=> b.name|lower : b.name|lower <=> a.name|lower) %}
{% elseif sort == 'handle' %}
    {% set filteredProviders = filteredProviders|sort((a, b) => dir == 'asc' ? a.handle|lower <=> b.handle|lower : b.handle|lower <=> a.handle|lower) %}
{% elseif sort == 'type' %}
    {% set filteredProviders = filteredProviders|sort((a, b) => dir == 'asc' ? a.type|lower <=> b.type|lower : b.type|lower <=> a.type|lower) %}
{% elseif sort == 'source' %}
    {% set filteredProviders = filteredProviders|sort((a, b) => dir == 'asc' ? (a.source ?? '') <=> (b.source ?? '') : (b.source ?? '') <=> (a.source ?? '')) %}
{% elseif sort == 'enabled' %}
    {% set filteredProviders = filteredProviders|sort((a, b) => dir == 'asc' ? a.enabled <=> b.enabled : b.enabled <=> a.enabled) %}
{% endif %}

{% set totalCount = filteredProviders|length %}
{% set paginatedProviders = filteredProviders|slice(offset, limit) %}


{# ============================================================================
   TABLE CONFIGURATION
   ============================================================================ #}

{% set tableConfig = {
    plugin: {
        handle: 'sms-manager',
        name: smsHelper.fullName,
    },
    page: {
        title: 'Providers'|t('sms-manager'),
        subnav: 'providers',
        crumbs: [
            { label: smsHelper.fullName, url: url('sms-manager') },
            { label: 'Providers'|t('sms-manager'), url: url('sms-manager/providers') }
        ],
    },
    filters: [
        {
            type: 'status',
            param: 'status',
            current: statusFilter,
            label: 'All'|t('sms-manager'),
            groups: [
                {
                    param: 'status',
                    current: statusFilter,
                    colorSet: 'status',
                    options: [
                        {value: 'all', label: 'All'|t('sms-manager'), status: 'all'},
                        {value: 'enabled', label: 'Enabled'|t('sms-manager'), colorKey: 'enabled'},
                        {value: 'disabled', label: 'Disabled'|t('sms-manager'), colorKey: 'disabled'},
                    ],
                },
                {
                    header: 'Config Source'|t('sms-manager'),
                    param: 'source',
                    current: sourceFilter,
                    colorSet: 'configSource',
                    options: [
                        {value: 'all', label: 'All Sources'|t('sms-manager'), status: 'all'},
                        {value: 'config', label: 'Config File'|t('sms-manager'), colorKey: 'config'},
                        {value: 'database', label: 'Database'|t('sms-manager'), colorKey: 'database'},
                    ],
                },
            ],
        },
    ],
    search: {
        placeholder: 'Search providers...'|t('sms-manager'),
        value: search,
    },
    sort: {
        field: sort,
        direction: dir,
    },
    table: {
        columns: [
            {key: 'name', label: 'Name'|t('sms-manager'), sortable: true},
            {key: 'handle', label: 'Handle'|t('sms-manager'), sortable: true},
            {key: 'type', label: 'Type'|t('sms-manager'), sortable: true},
            {key: 'source', label: 'Source'|t('sms-manager'), sortable: true},
            {key: 'enabled', label: 'Status'|t('sms-manager'), sortable: true},
            {key: 'default', label: 'Default'|t('sms-manager')},
        ],
        items: paginatedProviders,
        emptyMessage: 'No providers found.'|t('sms-manager'),
        hasConfigItems: true,
    },
    pagination: {
        page: page,
        limit: limit,
        totalCount: totalCount,
        itemLabel: {singular: 'provider'|t('sms-manager'), plural: 'providers'|t('sms-manager')},
    },
    checkboxes: canEdit or canDelete,
    newButton: canCreate ? {
        url: url('sms-manager/providers/new'),
        label: 'New Provider'|t('sms-manager'),
        permission: 'smsManager:createProviders',
    } : null,
} %}


{# ============================================================================
   BEFORE TABLE - Warning messages
   ============================================================================ #}

{% block beforeTable %}
    <style>
        /* Plugin-specific: Config tooltip header */
        .config-tooltip::before {
            content: 'config/sms-manager.php';
            display: block;
            color: #8f98a3;
            font-size: 10px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e3e5e8;
        }
    </style>

    {# Warning if default provider is missing or disabled #}
    {% if defaultProviderHandle %}
        {% set defaultProvider = providers|filter(p => p.handle == defaultProviderHandle)|first %}
        {% if not defaultProvider %}
            {# Default provider doesn't exist #}
            {% set warningMessage %}
            <strong>{{ 'Warning'|t('sms-manager') }}:</strong>
            {{ 'The default provider handle "{handle}" does not exist.'|t('sms-manager', {handle: defaultProviderHandle}) }}
            {% if isDefaultFromConfig %}
                {{ 'Update your config/sms-manager.php to point to a valid provider handle.'|t('sms-manager') }}
            {% else %}
                {{ 'Please set a different provider as default.'|t('sms-manager') }}
            {% endif %}
            {% endset %}
            <div class="info-box-table-wrapper">
                {% include 'lindemannrock-base/_components/info-box' with {
                    message: warningMessage,
                    type: 'warning',
                    margin: 'none',
                    stretch: true,
                } %}
            </div>
        {% elseif not defaultProvider.enabled %}
            {# Default provider exists but is disabled #}
            {% set warningMessage %}
            <strong>{{ 'Warning'|t('sms-manager') }}:</strong>
            {{ 'The default provider "{name}" is disabled. SMS functionality may not work.'|t('sms-manager', {name: defaultProvider.name}) }}
            {% if not isDefaultFromConfig %}
                {{ 'Please enable it or set a different provider as default.'|t('sms-manager') }}
            {% else %}
                {{ 'Update your config/sms-manager.php to fix this.'|t('sms-manager') }}
            {% endif %}
            {% endset %}
            <div class="info-box-table-wrapper">
                {% include 'lindemannrock-base/_components/info-box' with {
                    message: warningMessage,
                    type: 'warning',
                    margin: 'none',
                    stretch: true,
                } %}
            </div>
        {% endif %}
    {% elseif providers|length > 0 %}
        {# No default handle set but providers exist #}
        {% set warningMessage %}
        <strong>{{ 'Warning'|t('sms-manager') }}:</strong>
        {{ 'No default provider is configured. Please set one of the providers as default.'|t('sms-manager') }}
        {% endset %}
        <div class="info-box-table-wrapper">
            {% include 'lindemannrock-base/_components/info-box' with {
                message: warningMessage,
                type: 'warning',
                margin: 'none',
                stretch: true,
            } %}
        </div>
    {% endif %}
{% endblock %}


{# ============================================================================
   BULK ACTIONS (shown when items selected)
   ============================================================================ #}

{% block bulkActions %}
    {% if canEdit %}
        <div class="btngroup">
            <button type="button" class="btn menubtn secondary" id="lr-bulk-status-btn">
                {{ 'Set status'|t('app') }}
            </button>
            <div class="menu">
                <ul>
                    <li><a id="lr-bulk-enable-action">{{ 'Enable'|t('sms-manager') }}</a></li>
                    <li><a id="lr-bulk-disable-action">{{ 'Disable'|t('sms-manager') }}</a></li>
                </ul>
            </div>
        </div>
    {% endif %}
    {% if canDelete %}
        <button type="button" class="btn secondary" id="lr-bulk-delete-btn">
            {{ 'Delete'|t('app') }} (<span id="lr-selected-count">0</span>)
        </button>
    {% endif %}
{% endblock %}


{# ============================================================================
   ROW ACTIONS (per-row menu)
   ============================================================================ #}

{% block rowActions %}
    {% set isConfig = item.isFromConfig() %}
    {% set isDefault = defaultProviderHandle == item.handle %}

    <td class="thin" style="text-align: right;">
        <button type="button" class="btn menubtn" data-icon="settings" title="{{ 'Actions'|t('app') }}"></button>
        <div class="menu">
            <ul>
                {% if item.canEdit() %}
                    {% if canEdit %}
                        <li>
                            <a href="{{ url('sms-manager/providers/' ~ item.id) }}">
                                {{ 'Edit'|t('app') }}
                            </a>
                        </li>
                    {% endif %}
                {% else %}
                    <li>
                        <a href="{{ url('sms-manager/providers/view/' ~ item.handle) }}">
                            {{ 'View'|t('app') }}
                        </a>
                    </li>
                {% endif %}
                {% if canEdit and not isDefaultFromConfig and not isDefault %}
                    <li><hr class="padded"></li>
                    <li>
                        <a class="lr-provider-action" data-action="set-default" data-id="{{ item.id ?: item.handle }}" data-name="{{ item.name }}">
                            {{ 'Set as Default'|t('sms-manager') }}
                        </a>
                    </li>
                {% endif %}
                {% if canDelete and item.canEdit() and not isDefault %}
                    <li><hr class="padded"></li>
                    <li>
                        <a class="lr-provider-action error" data-action="delete" data-id="{{ item.id ?: item.handle }}" data-name="{{ item.name }}">
                            {{ 'Delete'|t('app') }}
                        </a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </td>
{% endblock %}


{# ============================================================================
   CUSTOM TABLE ROW RENDERING
   ============================================================================ #}

{% block tableRow %}
    {% set isConfig = item.isFromConfig() %}

    {# Name #}
    <td>
        {% if item.canEdit() %}
            <a class="label-link" href="{{ url('sms-manager/providers/' ~ item.id) }}">
                <span>{{ item.name }}</span>
            </a>
        {% else %}
            <a class="label-link" href="{{ url('sms-manager/providers/view/' ~ item.handle) }}">
                <span>{{ item.name }}</span>
            </a>
            <span class="config-info-icon" data-config="{{ item.rawConfigDisplay|e('html_attr') }}"></span>
        {% endif %}
    </td>

    {# Handle #}
    <td><code>{{ item.handle }}</code></td>

    {# Type badge #}
    <td>
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.type|upper,
            value: item.type,
            colorSet: 'smsProviderType',
        } only %}
    </td>

    {# Source badge #}
    <td>
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.source|capitalize,
            value: item.source,
            colorSet: 'configSource',
        } only %}
    </td>

    {# Status badge #}
    <td>
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.enabled ? 'Enabled'|t('sms-manager') : 'Disabled'|t('sms-manager'),
            value: item.enabled ? 'enabled' : 'disabled',
            colorSet: 'status',
        } only %}
    </td>

    {# Default indicator #}
    <td>
        {% if defaultProviderHandle == item.handle %}
            {% include 'lindemannrock-base/_components/badge' with {
                label: 'Yes'|t('sms-manager'),
                value: 'yes',
                colorSet: 'yesNo',
            } only %}
        {% else %}
            <span class="light">-</span>
        {% endif %}
    </td>
{% endblock %}


{# ============================================================================
   CUSTOM SCRIPTS
   ============================================================================ #}

{% block scripts %}
    <script>
    (function() {
        // Update selected count when selection changes
        document.addEventListener('lr:selectionChanged', function(e) {
            const countSpan = document.getElementById('lr-selected-count');
            if (countSpan) {
                countSpan.textContent = e.detail.count;
            }
        });

        // Bulk enable
        document.getElementById('lr-bulk-enable-action')?.addEventListener('click', function(e) {
            e.preventDefault();
            if (!window.lrTableSelection) return;

            const ids = window.lrTableSelection.getSelectedIds();
            if (ids.length === 0) return;

            Craft.sendActionRequest('POST', 'sms-manager/providers/bulk-enable', {
                data: { providerIds: ids }
            }).then(function(response) {
                if (response.data.count > 0) {
                    Craft.cp.displayNotice('{{ "Enabled {count} providers"|t("sms-manager")|e("js") }}'.replace('{count}', response.data.count));
                }
                if (response.data.errors && response.data.errors.length > 0) {
                    response.data.errors.forEach(err => Craft.cp.displayError(err));
                }
                if (response.data.count > 0) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('{{ "Failed to enable providers"|t("sms-manager")|e("js") }}');
            });
        });

        // Bulk disable
        document.getElementById('lr-bulk-disable-action')?.addEventListener('click', function(e) {
            e.preventDefault();
            if (!window.lrTableSelection) return;

            const ids = window.lrTableSelection.getSelectedIds();
            if (ids.length === 0) return;

            Craft.sendActionRequest('POST', 'sms-manager/providers/bulk-disable', {
                data: { providerIds: ids }
            }).then(function(response) {
                if (response.data.count > 0) {
                    Craft.cp.displayNotice('{{ "Disabled {count} providers"|t("sms-manager")|e("js") }}'.replace('{count}', response.data.count));
                }
                if (response.data.errors && response.data.errors.length > 0) {
                    response.data.errors.forEach(err => Craft.cp.displayError(err));
                } else if (response.data.error) {
                    Craft.cp.displayError(response.data.error);
                }
                if (response.data.count > 0) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('{{ "Failed to disable providers"|t("sms-manager")|e("js") }}');
            });
        });

        // Bulk delete
        document.getElementById('lr-bulk-delete-btn')?.addEventListener('click', function(e) {
            e.preventDefault();
            if (!window.lrTableSelection) return;

            const ids = window.lrTableSelection.getSelectedIds();
            const count = window.lrTableSelection.getCount();

            if (count === 0) return;

            if (!confirm('{{ "Delete {count} provider(s)? This cannot be undone."|t("sms-manager")|e("js") }}'.replace('{count}', count))) {
                return;
            }

            Craft.sendActionRequest('POST', 'sms-manager/providers/bulk-delete', {
                data: { providerIds: ids }
            }).then(function(response) {
                if (response.data.count > 0) {
                    Craft.cp.displayNotice('{{ "Deleted {count} providers"|t("sms-manager")|e("js") }}'.replace('{count}', response.data.count));
                }
                if (response.data.errors && response.data.errors.length > 0) {
                    response.data.errors.forEach(err => Craft.cp.displayError(err));
                } else if (response.data.error) {
                    Craft.cp.displayError(response.data.error);
                }
                if (response.data.count > 0) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('{{ "Failed to delete providers"|t("sms-manager")|e("js") }}');
            });
        });

        // Individual provider action menu clicks
        document.querySelectorAll('.lr-provider-action').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                const action = this.dataset.action;
                const providerId = this.dataset.id;
                const providerName = this.dataset.name;

                if (action === 'set-default') {
                    Craft.sendActionRequest('POST', 'sms-manager/providers/set-default', {
                        data: { providerId: providerId }
                    }).then(function(response) {
                        if (response.data.success) {
                            Craft.cp.displayNotice('{{ "Default provider updated"|t("sms-manager")|e("js") }}');
                            setTimeout(() => window.location.reload(), 500);
                        } else {
                            Craft.cp.displayError(response.data.error || '{{ "Failed to update default provider"|t("sms-manager")|e("js") }}');
                        }
                    }).catch(function(error) {
                        Craft.cp.displayError('{{ "Failed to update default provider"|t("sms-manager")|e("js") }}');
                    });
                } else if (action === 'delete') {
                    if (confirm('{{ "Delete provider \"{name}\"? This cannot be undone."|t("sms-manager")|e("js") }}'.replace('{name}', providerName))) {
                        Craft.sendActionRequest('POST', 'sms-manager/providers/delete', {
                            data: { providerId: providerId }
                        }).then(function(response) {
                            if (response.data.success) {
                                Craft.cp.displayNotice('{{ "Provider deleted"|t("sms-manager")|e("js") }}');
                                setTimeout(() => window.location.reload(), 1000);
                            } else if (response.data.error) {
                                Craft.cp.displayError(response.data.error);
                            }
                        }).catch(function(error) {
                            Craft.cp.displayError('{{ "Failed to delete provider"|t("sms-manager")|e("js") }}');
                        });
                    }
                }
            });
        });
    })();
    </script>
{% endblock %}
