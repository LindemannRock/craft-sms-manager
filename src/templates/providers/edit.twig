{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set plugin = craft.app.plugins.getPlugin('sms-manager') %}
{% set canEdit = provider ? provider.canEdit() : true %}
{% set title = isNew ? 'New Provider'|t('sms-manager') : provider.name %}
{% set fullPageForm = canEdit %}
{% set selectedSubnavItem = 'providers' %}
{% set saveShortcutRedirect = cpUrl('sms-manager/providers/{id}') %}
{% set retainScrollOnSaveShortcut = true %}

{% set crumbs = [
    { label: smsHelper.fullName, url: url('sms-manager') },
    { label: 'Providers'|t('sms-manager'), url: url('sms-manager/providers') },
    { label: isNew ? 'New Provider'|t('sms-manager') : provider.name }
] %}

{# Set up tabs #}
{% if canEdit %}
    {% set tabs = {
        fields: {
            label: 'Settings'|t('sms-manager'),
            url: '#fields',
        },
    } %}
{% endif %}

{% block actionButton %}
    {% if canEdit %}
        <div class="btngroup submit">
            <button type="submit" class="btn submit">{{ "Save"|t('app') }}</button>
            <button type="button" class="btn submit menubtn"></button>
            <div class="menu">
                <ul role="listbox">
                    <li>
                        <a class="formsubmit" role="option" tabindex="0" data-redirect="{{ cpUrl('sms-manager/providers/{id}')|hash }}">
                            <span class="label">{{ 'Save and continue editing'|t('app') }}</span>
                            <span class="shortcut" id="save-shortcut"></span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        {% set isDefault = provider and defaultProviderHandle == provider.handle %}
        {% if not isNew and currentUser.can('smsManager:deleteProviders') and not isDefault %}
            <button type="button" id="action-btn" class="btn menubtn action-btn hairline-dark m" title="{{ 'Actions'|t('app') }}" aria-controls="action-menu" aria-label="{{ 'Actions'|t('app') }}" data-disclosure-trigger="true" aria-expanded="false"></button>
            <div id="action-menu" class="menu menu--disclosure">
                <ul>
                    <li>
                        <button class="menu-item error formsubmit" data-destructive data-action="sms-manager/providers/delete" data-params='{"providerId":{{ provider.id }}}' data-confirm="{{ 'Are you sure you want to delete this provider?'|t('sms-manager') }}" data-redirect="{{ 'sms-manager/providers'|hash }}">
                            <span class="icon">{{ svg('@app/icons/trash.svg') }}</span>
                            <span class="menu-item-label">{{ "Delete"|t('app') }}</span>
                        </button>
                    </li>
                </ul>
            </div>
        {% endif %}
    {% endif %}
{% endblock %}

{% block content %}
    {% if canEdit %}
        {# Editable form for database providers #}
        <input type="hidden" name="action" value="sms-manager/providers/save">
        <input type="hidden" name="redirect" value="{{ 'sms-manager/providers'|hash }}">
        {% if not isNew %}
            <input type="hidden" name="providerId" value="{{ provider.id }}">
        {% endif %}
        {{ csrfInput() }}

        <div id="fields">
            {{ forms.textField({
                first: true,
                label: 'Name'|t('sms-manager'),
                instructions: 'The name of this provider'|t('sms-manager'),
                id: 'name',
                name: 'name',
                value: provider.name ?? '',
                required: true,
                errors: provider ? provider.getErrors('name') : [],
            }) }}

            {{ forms.textField({
                label: 'Handle'|t('sms-manager'),
                instructions: 'How you will refer to this provider in code'|t('sms-manager'),
                id: 'handle',
                name: 'handle',
                class: 'code',
                value: provider.handle ?? '',
                errors: provider ? provider.getErrors('handle') : [],
            }) }}

            {{ forms.selectField({
                label: 'Provider Type'|t('sms-manager'),
                instructions: 'The SMS provider type'|t('sms-manager'),
                id: 'type',
                name: 'type',
                value: provider.type ?? 'mpp-sms',
                options: providerTypes,
                required: true,
            }) }}

            <hr>

            <h2>{{ 'Provider Settings'|t('sms-manager') }}</h2>

            {# Provider-specific settings - loaded based on type #}
            {% set currentType = provider.type ?? 'mpp-sms' %}

            <div id="provider-settings">
                {# MPP-SMS Settings #}
                <div id="settings-mpp-sms" class="provider-type-settings {{ currentType != 'mpp-sms' ? 'hidden' : '' }}">
                    {% include 'sms-manager/providers/_settings/mpp-sms' with {
                        providerSettings: currentType == 'mpp-sms' ? providerSettings : {}
                    } %}
                </div>

                {# Generic/Fallback Settings (for future provider types) #}
                <div id="settings-generic" class="provider-type-settings {{ currentType == 'mpp-sms' ? 'hidden' : '' }}">
                    {{ forms.textField({
                        label: 'API Key'|t('sms-manager'),
                        instructions: 'The API key for this provider'|t('sms-manager'),
                        id: 'providerSettings-apiKey-generic',
                        name: 'providerSettings[apiKey]',
                        value: currentType != 'mpp-sms' ? (providerSettings.apiKey ?? '') : '',
                        required: true,
                        class: 'code',
                    }) }}

                    {{ forms.textField({
                        label: 'API URL'|t('sms-manager'),
                        instructions: 'The API endpoint URL'|t('sms-manager'),
                        id: 'providerSettings-apiUrl-generic',
                        name: 'providerSettings[apiUrl]',
                        value: currentType != 'mpp-sms' ? (providerSettings.apiUrl ?? '') : '',
                        class: 'code',
                    }) }}

                    {{ forms.textField({
                        label: 'Username'|t('sms-manager'),
                        instructions: 'API username (if required)'|t('sms-manager'),
                        id: 'providerSettings-username-generic',
                        name: 'providerSettings[username]',
                        value: currentType != 'mpp-sms' ? (providerSettings.username ?? '') : '',
                    }) }}

                    {{ forms.passwordField({
                        label: 'Password'|t('sms-manager'),
                        instructions: 'API password (if required)'|t('sms-manager'),
                        id: 'providerSettings-password-generic',
                        name: 'providerSettings[password]',
                        value: currentType != 'mpp-sms' ? (providerSettings.password ?? '') : '',
                    }) }}
                </div>
            </div>
        </div>
    {% else %}
        {# Read-only view for config providers #}
        <div class="pane">
            <h2>{{ 'Configuration'|t('sms-manager') }}</h2>
            <p class="light">{{ 'This provider is defined in your config file and cannot be edited here.'|t('sms-manager') }}</p>
            {% if provider.rawConfigDisplay %}
                <pre style="background: #f3f7fc; padding: 14px; border-radius: 4px; overflow-x: auto; font-size: 12px;"><code>{{ provider.rawConfigDisplay }}</code></pre>
            {% endif %}
        </div>
    {% endif %}

    {% include 'lindemannrock-base/_components/plugin-credit' %}
{% endblock %}

{% block details %}
    {% set isDefault = provider and defaultProviderHandle == provider.handle %}
    {% set isFirstProvider = isNew and (providerCount ?? 0) == 0 %}

    <div class="meta">
        {# Enabled toggle #}
        {% if canEdit %}
            {% if isDefault %}
                {{ forms.lightswitchField({
                    label: 'Enabled'|t('sms-manager'),
                    instructions: 'Default provider cannot be disabled.'|t('sms-manager'),
                    id: 'enabled',
                    name: 'enabled',
                    on: true,
                    disabled: true
                }) }}
                <input type="hidden" name="enabled" value="1">
            {% elseif isFirstProvider %}
                {{ forms.lightswitchField({
                    label: 'Enabled'|t('sms-manager'),
                    instructions: 'First provider must be enabled.'|t('sms-manager'),
                    id: 'enabled',
                    name: 'enabled',
                    on: true,
                    disabled: true
                }) }}
                <input type="hidden" name="enabled" value="1">
            {% else %}
                {{ forms.lightswitchField({
                    label: 'Enabled'|t('sms-manager'),
                    id: 'enabled',
                    name: 'enabled',
                    on: provider.enabled ?? true
                }) }}
            {% endif %}
        {% else %}
            {# Config provider - show as read-only #}
            {{ forms.lightswitchField({
                label: 'Enabled'|t('sms-manager'),
                instructions: 'Set via config/sms-manager.php. Edit the file to change.'|t('sms-manager'),
                id: 'enabled',
                on: provider.enabled ?? true,
                disabled: true
            }) }}
        {% endif %}

        {# Default toggle - shown for all providers (config or database) #}
        {% if not isNew %}
            {% if isDefaultFromConfig %}
                {# Default is set via config - disable for ALL providers #}
                {{ forms.lightswitchField({
                    label: 'Default Provider'|t('sms-manager'),
                    instructions: 'Set via config/sms-manager.php. Edit the file to change.'|t('sms-manager'),
                    id: 'isDefault',
                    on: isDefault,
                    disabled: true
                }) }}
            {% elseif isDefault %}
                {# This is the current default (not from config) #}
                {{ forms.lightswitchField({
                    label: 'Default Provider'|t('sms-manager'),
                    instructions: 'To change, set another provider as default first.'|t('sms-manager'),
                    id: 'isDefault',
                    name: 'isDefault',
                    on: true,
                    disabled: true
                }) }}
                {% if canEdit %}
                    <input type="hidden" name="isDefault" value="1">
                {% endif %}
            {% elseif canEdit or currentUser.can('smsManager:editProviders') %}
                {# Can toggle default: form submission for database, AJAX for config #}
                {{ forms.lightswitchField({
                    label: 'Default Provider'|t('sms-manager'),
                    instructions: 'Use this provider when no specific provider is specified.'|t('sms-manager'),
                    id: 'isDefault',
                    name: 'isDefault',
                    on: false
                }) }}
            {% endif %}
        {% elseif isFirstProvider %}
            {{ forms.lightswitchField({
                label: 'Default Provider'|t('sms-manager'),
                instructions: 'First provider is automatically set as default.'|t('sms-manager'),
                id: 'isDefault',
                name: 'isDefault',
                on: true,
                disabled: true
            }) }}
            <input type="hidden" name="isDefault" value="1">
        {% endif %}
    </div>

    {% if not isNew %}
    <fieldset>
        <dl class="meta read-only">
            <div class="data">
                <dt class="heading">{{ 'Status'|t('sms-manager') }}</dt>
                <dd class="value">
                    <span class="status {{ provider.enabled ? 'live' : 'disabled' }}"></span>
                    <span>{{ provider.enabled ? 'Enabled'|t('sms-manager') : 'Disabled'|t('sms-manager') }}</span>
                </dd>
            </div>
            <div class="data">
                <dt class="heading">{{ 'Handle'|t('sms-manager') }}</dt>
                <dd class="value"><code>{{ provider.handle }}</code></dd>
            </div>
            <div class="data">
                <dt class="heading">{{ 'Type'|t('sms-manager') }}</dt>
                <dd class="value">{{ provider.type|upper }}</dd>
            </div>
            <div class="data">
                <dt class="heading">{{ 'Source'|t('sms-manager') }}</dt>
                <dd class="value">
                    {% if provider.source == 'config' %}
                        {{ 'Config File'|t('sms-manager') }}
                    {% else %}
                        {{ 'Database'|t('sms-manager') }}
                    {% endif %}
                </dd>
            </div>
            {% if isDefault %}
                <div class="data">
                    <dt class="heading">{{ 'Default'|t('sms-manager') }}</dt>
                    <dd class="value">{{ 'Yes'|t('sms-manager') }}</dd>
                </div>
            {% endif %}
            {% if not canEdit %}
                {# Config providers don't have database IDs or timestamps #}
            {% else %}
                <div class="data">
                    <dt class="heading">{{ 'ID'|t('app') }}</dt>
                    <dd class="value">{{ provider.id }}</dd>
                </div>
                {% if provider.dateCreated %}
                    <div class="data">
                        <dt class="heading">{{ 'Created'|t('app') }}</dt>
                        <dd class="value">{{ provider.dateCreated|datetime('short') }}</dd>
                    </div>
                {% endif %}
                {% if provider.dateUpdated %}
                    <div class="data">
                        <dt class="heading">{{ 'Updated'|t('app') }}</dt>
                        <dd class="value">{{ provider.dateUpdated|datetime('short') }}</dd>
                    </div>
                {% endif %}
            {% endif %}
        </dl>
    </fieldset>
    {% endif %}
{% endblock %}

{% if canEdit %}
{% js %}
// Auto-generate handle from name
const nameField = document.getElementById('name');
const handleField = document.getElementById('handle');
let handleChanged = {{ (provider.handle ?? '') ? 'true' : 'false' }};

handleField.addEventListener('input', function() {
    handleChanged = true;
});

nameField.addEventListener('input', function() {
    if (!handleChanged) {
        handleField.value = this.value
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
    }
});

// Provider type switching
const typeSelect = document.getElementById('type');
const providerSettingsContainers = document.querySelectorAll('.provider-type-settings');

function switchProviderSettings(type) {
    providerSettingsContainers.forEach(container => {
        container.classList.add('hidden');
        // Disable inputs in hidden containers to prevent submission
        container.querySelectorAll('input, select, textarea').forEach(input => {
            input.disabled = true;
        });
    });

    // Show and enable the selected type's settings
    let targetId = 'settings-' + type;
    let targetContainer = document.getElementById(targetId);

    // Fall back to generic if no specific settings exist
    if (!targetContainer) {
        targetContainer = document.getElementById('settings-generic');
    }

    if (targetContainer) {
        targetContainer.classList.remove('hidden');
        targetContainer.querySelectorAll('input, select, textarea').forEach(input => {
            input.disabled = false;
        });
    }
}

if (typeSelect) {
    typeSelect.addEventListener('change', function() {
        switchProviderSettings(this.value);
    });

    // Initialize on page load
    switchProviderSettings(typeSelect.value);
}

// Set platform-specific keyboard shortcut
const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
const saveShortcut = document.getElementById('save-shortcut');
if (saveShortcut) {
    saveShortcut.textContent = isMac ? 'âŒ˜S' : 'Ctrl+S';
}
{% endjs %}
{% endif %}
