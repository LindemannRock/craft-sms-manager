{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set plugin = craft.app.plugins.getPlugin('sms-manager') %}
{% set title = isNew ? 'New Provider'|t('sms-manager') : 'Edit Provider'|t('sms-manager') %}
{% set fullPageForm = true %}
{% set selectedSubnavItem = 'providers' %}
{% set saveShortcutRedirect = cpUrl('sms-manager/providers/{id}') %}
{% set retainScrollOnSaveShortcut = true %}

{% set crumbs = [
    { label: smsHelper.fullName, url: url('sms-manager') },
    { label: 'Providers'|t('sms-manager'), url: url('sms-manager/providers') },
    { label: isNew ? 'New Provider'|t('sms-manager') : provider.name }
] %}

{# Set up tabs #}
{% set tabs = {
    fields: {
        label: 'Settings'|t('sms-manager'),
        url: '#fields',
    },
} %}

{% block actionButton %}
    <div class="btngroup submit">
        <button type="submit" class="btn submit">{{ "Save"|t('app') }}</button>
        <button type="button" class="btn submit menubtn"></button>
        <div class="menu">
            <ul role="listbox">
                <li>
                    <a class="formsubmit" role="option" tabindex="0" data-redirect="{{ cpUrl('sms-manager/providers/{id}')|hash }}">
                        <span class="label">{{ 'Save and continue editing'|t('app') }}</span>
                        <span class="shortcut" id="save-shortcut"></span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    {% if not isNew and currentUser.can('smsManager:deleteProviders') %}
        <button type="button" id="action-btn" class="btn menubtn action-btn hairline-dark m" title="{{ 'Actions'|t('app') }}" aria-controls="action-menu" aria-label="{{ 'Actions'|t('app') }}" data-disclosure-trigger="true" aria-expanded="false"></button>
        <div id="action-menu" class="menu menu--disclosure">
            <ul>
                <li>
                    <button class="menu-item error formsubmit" data-destructive data-action="sms-manager/providers/delete" data-params='{"providerId":{{ provider.id }}}' data-confirm="{{ 'Are you sure you want to delete this provider?'|t('sms-manager') }}" data-redirect="{{ 'sms-manager/providers'|hash }}" data-headers='{"Accept":"application/json"}'>
                        <span class="icon">{{ svg('@app/icons/trash.svg') }}</span>
                        <span class="menu-item-label">{{ "Delete"|t('app') }}</span>
                    </button>
                </li>
            </ul>
        </div>
    {% endif %}
{% endblock %}

{% block content %}
    <input type="hidden" name="action" value="sms-manager/providers/save">
    <input type="hidden" name="redirect" value="{{ 'sms-manager/providers'|hash }}">
    {% if not isNew %}
        <input type="hidden" name="providerId" value="{{ provider.id }}">
    {% endif %}
    {{ csrfInput() }}

    <div id="fields">
        {{ forms.textField({
            first: true,
            label: 'Name'|t('sms-manager'),
            instructions: 'The name of this provider'|t('sms-manager'),
            id: 'name',
            name: 'name',
            value: provider.name ?? '',
            required: true,
            errors: provider ? provider.getErrors('name') : [],
        }) }}

        {{ forms.textField({
            label: 'Handle'|t('sms-manager'),
            instructions: 'How you will refer to this provider in code'|t('sms-manager'),
            id: 'handle',
            name: 'handle',
            class: 'code',
            value: provider.handle ?? '',
            errors: provider ? provider.getErrors('handle') : [],
        }) }}

        {{ forms.selectField({
            label: 'Provider Type'|t('sms-manager'),
            instructions: 'The SMS provider type'|t('sms-manager'),
            id: 'type',
            name: 'type',
            value: provider.type ?? 'mpp-sms',
            options: providerTypes,
            required: true,
        }) }}

        <hr>

        <h2>{{ 'Provider Settings'|t('sms-manager') }}</h2>

        {# Provider-specific settings - loaded based on type #}
        {% set currentType = provider.type ?? 'mpp-sms' %}

        <div id="provider-settings">
            {# MPP-SMS Settings #}
            <div id="settings-mpp-sms" class="provider-type-settings {{ currentType != 'mpp-sms' ? 'hidden' : '' }}">
                {% include 'sms-manager/providers/_settings/mpp-sms' with {
                    providerSettings: currentType == 'mpp-sms' ? providerSettings : {}
                } %}
            </div>

            {# Generic/Fallback Settings (for future provider types) #}
            <div id="settings-generic" class="provider-type-settings {{ currentType == 'mpp-sms' ? 'hidden' : '' }}">
                {{ forms.textField({
                    label: 'API Key'|t('sms-manager'),
                    instructions: 'The API key for this provider'|t('sms-manager'),
                    id: 'providerSettings-apiKey-generic',
                    name: 'providerSettings[apiKey]',
                    value: currentType != 'mpp-sms' ? (providerSettings.apiKey ?? '') : '',
                    required: true,
                    class: 'code',
                }) }}

                {{ forms.textField({
                    label: 'API URL'|t('sms-manager'),
                    instructions: 'The API endpoint URL'|t('sms-manager'),
                    id: 'providerSettings-apiUrl-generic',
                    name: 'providerSettings[apiUrl]',
                    value: currentType != 'mpp-sms' ? (providerSettings.apiUrl ?? '') : '',
                    class: 'code',
                }) }}

                {{ forms.textField({
                    label: 'Username'|t('sms-manager'),
                    instructions: 'API username (if required)'|t('sms-manager'),
                    id: 'providerSettings-username-generic',
                    name: 'providerSettings[username]',
                    value: currentType != 'mpp-sms' ? (providerSettings.username ?? '') : '',
                }) }}

                {{ forms.passwordField({
                    label: 'Password'|t('sms-manager'),
                    instructions: 'API password (if required)'|t('sms-manager'),
                    id: 'providerSettings-password-generic',
                    name: 'providerSettings[password]',
                    value: currentType != 'mpp-sms' ? (providerSettings.password ?? '') : '',
                }) }}
            </div>
        </div>
    </div>
{% endblock %}

{% block details %}
    <div class="meta">
        {{ forms.lightswitchField({
            label: 'Enabled'|t('sms-manager'),
            id: 'enabled',
            name: 'enabled',
            on: provider.enabled ?? true
        }) }}

        {{ forms.lightswitchField({
            label: 'Default Provider'|t('sms-manager'),
            instructions: 'Use this provider when no specific provider is specified.'|t('sms-manager'),
            id: 'isDefault',
            name: 'isDefault',
            on: provider.isDefault ?? false
        }) }}
    </div>

    {% if not isNew %}
        <fieldset>
            <dl class="meta read-only">
                <div class="data">
                    <dt class="heading">{{ 'Status'|t('sms-manager') }}</dt>
                    <dd class="value">
                        <span class="status {{ provider.enabled ? 'live' : 'disabled' }}"></span>
                        <span>{{ provider.enabled ? 'Enabled'|t('sms-manager') : 'Disabled'|t('sms-manager') }}</span>
                    </dd>
                </div>
                <div class="data">
                    <dt class="heading">{{ 'ID'|t('app') }}</dt>
                    <dd class="value">{{ provider.id }}</dd>
                </div>
                <div class="data">
                    <dt class="heading">{{ 'Created'|t('app') }}</dt>
                    <dd class="value">{{ provider.dateCreated|datetime('short') }}</dd>
                </div>
                <div class="data">
                    <dt class="heading">{{ 'Updated'|t('app') }}</dt>
                    <dd class="value">{{ provider.dateUpdated|datetime('short') }}</dd>
                </div>
            </dl>
        </fieldset>
    {% endif %}
{% endblock %}

{% js %}
// Auto-generate handle from name
const nameField = document.getElementById('name');
const handleField = document.getElementById('handle');
let handleChanged = {{ (provider.handle ?? '') ? 'true' : 'false' }};

handleField.addEventListener('input', function() {
    handleChanged = true;
});

nameField.addEventListener('input', function() {
    if (!handleChanged) {
        handleField.value = this.value
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
    }
});

// Provider type switching
const typeSelect = document.getElementById('type');
const providerSettingsContainers = document.querySelectorAll('.provider-type-settings');

function switchProviderSettings(type) {
    providerSettingsContainers.forEach(container => {
        container.classList.add('hidden');
        // Disable inputs in hidden containers to prevent submission
        container.querySelectorAll('input, select, textarea').forEach(input => {
            input.disabled = true;
        });
    });

    // Show and enable the selected type's settings
    let targetId = 'settings-' + type;
    let targetContainer = document.getElementById(targetId);

    // Fall back to generic if no specific settings exist
    if (!targetContainer) {
        targetContainer = document.getElementById('settings-generic');
    }

    if (targetContainer) {
        targetContainer.classList.remove('hidden');
        targetContainer.querySelectorAll('input, select, textarea').forEach(input => {
            input.disabled = false;
        });
    }
}

if (typeSelect) {
    typeSelect.addEventListener('change', function() {
        switchProviderSettings(this.value);
    });

    // Initialize on page load
    switchProviderSettings(typeSelect.value);
}

// Set platform-specific keyboard shortcut
const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
const saveShortcut = document.getElementById('save-shortcut');
if (saveShortcut) {
    saveShortcut.textContent = isMac ? 'âŒ˜S' : 'Ctrl+S';
}
{% endjs %}
