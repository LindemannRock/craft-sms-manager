{#
 # SMS Logs Index - Using cp-table layout
 #
 # This template extends the base plugin's cp-table layout to provide
 # a consistent interface for viewing SMS logs with filters, sorting,
 # and expandable row details.
 #}

{% extends 'lindemannrock-base/_layouts/cp-table' %}

{# ============================================================================
   BUILD FILTER OPTIONS
   ============================================================================ #}

{# Build language options from Craft sites #}
{% set languageOptions = [{value: 'all', label: 'All Languages'|t('sms-manager')}] %}
{% set seenLanguages = [] %}
{% for site in craft.app.sites.getAllSites() %}
    {% set langCode = site.language|split('-')|first %}
    {% if langCode not in seenLanguages %}
        {% set seenLanguages = seenLanguages|merge([langCode]) %}
        {% set languageOptions = languageOptions|merge([{
            value: langCode,
            label: site.language ~ ' (' ~ site.name ~ ')'
        }]) %}
    {% endif %}
{% endfor %}

{# Build source options #}
{% set sourceOptions = [
    {value: 'all', label: 'All Sources'|t('sms-manager')},
    {value: 'direct', label: 'Direct'|t('sms-manager')},
] %}
{% for source in sources %}
    {% set sourceOptions = sourceOptions|merge([{value: source, label: source}]) %}
{% endfor %}


{# ============================================================================
   TABLE CONFIGURATION
   ============================================================================ #}

{% set tableConfig = {
    plugin: {
        handle: 'sms-manager',
        name: smsHelper.fullName,
    },
    page: {
        title: 'SMS Logs'|t('sms-manager'),
        subnav: 'dashboard',
        crumbs: [
            { label: smsHelper.fullName, url: url('sms-manager') },
        ],
    },
    filters: [
        {
            type: 'status',
            param: 'status',
            current: statusFilter,
            label: 'All Status'|t('sms-manager'),
            colorSet: 'smsStatus',
            options: [
                {value: 'all', label: 'All'|t('sms-manager'), status: 'all'},
                {value: 'sent', label: 'Sent'|t('sms-manager'), colorKey: 'sent'},
                {value: 'failed', label: 'Failed'|t('sms-manager'), colorKey: 'failed'},
                {value: 'pending', label: 'Pending'|t('sms-manager'), colorKey: 'pending'},
            ],
        },
        {
            type: 'dropdown',
            param: 'language',
            current: languageFilter,
            label: 'All Languages'|t('sms-manager'),
            options: languageOptions,
        },
        {
            type: 'dropdown',
            param: 'source',
            current: sourceFilter,
            label: 'All Sources'|t('sms-manager'),
            options: sourceOptions,
        },
        {
            type: 'dateRange',
            param: 'dateRange',
            current: dateRange,
            label: 'Date Range'|t('sms-manager'),
        },
        {
            type: 'hidden',
            param: 'provider',
            current: providerFilter,
        },
    ],
    search: {
        placeholder: 'Search logs...'|t('sms-manager'),
        value: search,
    },
    sort: {
        field: sort,
        direction: dir,
    },
    table: {
        columns: [
            {key: 'dateCreated', label: 'Sent'|t('sms-manager'), sortable: true},
            {key: 'recipient', label: 'Recipient'|t('sms-manager'), sortable: true},
            {key: 'message', label: 'Message'|t('sms-manager')},
            {key: 'language', label: 'Language'|t('sms-manager'), sortable: true, hideable: true},
            {key: 'status', label: 'Status'|t('sms-manager'), sortable: true},
            {key: 'providerName', label: 'Provider'|t('sms-manager'), hideable: true},
            {key: 'senderIdValue', label: 'Sender ID'|t('sms-manager'), hideable: true},
            {key: 'sourcePlugin', label: 'Source'|t('sms-manager'), hideable: true},
        ],
        items: logs,
        emptyMessage: 'No logs found.'|t('sms-manager'),
        expandable: true,
    },
    pagination: {
        page: page,
        limit: limit,
        totalCount: totalCount,
        itemLabel: {singular: 'log'|t('sms-manager'), plural: 'logs'|t('sms-manager')},
    },
    checkboxes: currentUser.can('smsManager:deleteLogs'),
    footerActions: [],
    ajax: {
        enabled: settings.refreshIntervalSecs > 0,
        interval: settings.refreshIntervalSecs,
        endpoint: actionUrl('sms-manager/logs/get-logs-data'),
    },
} %}


{# ============================================================================
   TOOLBAR ACTIONS
   ============================================================================ #}

{% block toolbarActions %}
    {# Export moved to extraFooter for consistent layout #}
{% endblock %}


{# ============================================================================
   BULK ACTIONS (shown when items selected)
   ============================================================================ #}

{% block bulkActions %}
    {% if currentUser.can('smsManager:deleteLogs') %}
        <button type="button" class="btn secondary" id="lr-delete-btn">
            {{ 'Delete'|t('sms-manager') }} (<span id="lr-selected-count">0</span>)
        </button>
    {% endif %}
{% endblock %}


{# ============================================================================
   EXTRA FOOTER (always visible - export button)
   ============================================================================ #}

{% block extraFooter %}
    {% if currentUser.can('smsManager:downloadLogs') %}
        {% include 'lindemannrock-base/_components/export-menu' with {
            action: 'sms-manager/sms-logs/export',
            permission: 'smsManager:downloadLogs',
            selectionAware: true,
            idsParam: 'logIds',
        } only %}
    {% endif %}
{% endblock %}


{# ============================================================================
   ROW ACTIONS (per-row delete button)
   ============================================================================ #}

{% block rowActions %}
    {% include 'lindemannrock-base/_components/row-actions' with {
        item: item,
        actions: {
            type: 'menu',
            icon: 'settings',
            title: 'Actions'|t('app'),
            permission: 'smsManager:deleteLogs',
            items: [
                {
                    label: 'Delete'|t('app'),
                    class: 'error',
                    permission: 'smsManager:deleteLogs',
                    jsAction: 'delete',
                },
            ],
        },
    } only %}
{% endblock %}


{# ============================================================================
   CUSTOM TABLE ROW RENDERING
   ============================================================================ #}

{% block tableRow %}
    {# Sent date #}
    <td class="light">{{ item.dateCreated|lrDatetime('medium') }}</td>

    {# Recipient #}
    <td><code>{{ item.recipient }}</code></td>

    {# Message (truncated) #}
    <td class="message-cell" title="{{ item.message }}" style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
        {{ item.message|slice(0, 50) }}{% if item.message|length > 50 %}...{% endif %}
    </td>

    {# Language #}
    <td>
        {% set langLabel = item.language %}
        {% for lang in languageOptions %}
            {% if lang.value == item.language %}
                {% set langLabel = lang.label %}
            {% endif %}
        {% endfor %}
        <span class="light">{{ langLabel }}</span>
    </td>

    {# Status badge #}
    <td>
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.status|capitalize,
            value: item.status,
            colorSet: 'smsStatus',
        } only %}
    </td>

    {# Provider #}
    <td><span class="light">{{ item.providerName }}</span></td>

    {# Sender ID #}
    <td><span class="light">{{ item.senderIdValue }}</span></td>

    {# Source #}
    <td>
        {% if item.sourcePlugin %}
            <span class="light">{{ item.sourcePlugin }}</span>
        {% else %}
            <span class="light">{{ 'Direct'|t('sms-manager') }}</span>
        {% endif %}
    </td>
{% endblock %}


{# ============================================================================
   EXPANDABLE ROW DETAILS
   ============================================================================ #}

{% block expandableRow %}
    {% set isRtl = item.language|slice(0, 2) == 'ar' %}

    <style>
        .context-label {
            font-size: 11px;
            color: #606d7b;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .context-value {
            font-family: Monaco, 'Courier New', monospace;
            font-size: 12px;
            background: #ffffff;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            padding: 8px 12px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .context-grid {
            display: grid;
            gap: 12px;
        }
        .lr-context-row.error .lr-context-content {
            border-left-color: #ef4444;
        }
    </style>

    <div class="context-grid">
        {# Full message #}
        <div>
            <div class="context-label">{{ 'Full Message'|t('sms-manager') }}</div>
            <div class="context-value"{{ isRtl ? ' dir="rtl"' : '' }}>{{ item.message }}</div>
        </div>

        {# Error message (if failed) #}
        {% if item.errorMessage %}
            <div>
                <div class="context-label" style="color: #dc2626;">{{ 'Error'|t('sms-manager') }}</div>
                <div class="context-value" style="border-color: #fecaca; background: #fef2f2;">{{ item.errorMessage }}</div>
            </div>
        {% endif %}

        {# Provider response #}
        {% if item.providerResponse %}
            <div>
                <div class="context-label">{{ 'Provider Response'|t('sms-manager') }}</div>
                <div class="context-value">{{ item.providerResponse }}</div>
            </div>
        {% endif %}

        {# Sender ID used #}
        <div>
            <div class="context-label">{{ 'Sender ID'|t('sms-manager') }}</div>
            <div class="context-value">{{ item.senderIdValue ?? 'Unknown' }}</div>
        </div>

        {# Provider Message ID #}
        {% if item.providerMessageId %}
            <div>
                <div class="context-label">{{ 'Message ID'|t('sms-manager') }}</div>
                <div class="context-value">{{ item.providerMessageId }}</div>
            </div>
        {% endif %}
    </div>
{% endblock %}


{# ============================================================================
   CUSTOM SCRIPTS
   ============================================================================ #}

{% block scripts %}
    <script>
    // Add error class to context rows for failed items
    document.querySelectorAll('.lr-data-row').forEach(row => {
        const statusCell = row.querySelector('td:nth-child(5) .status-label');
        if (statusCell) {
            const statusText = statusCell.textContent.trim().toLowerCase();
            if (statusText === 'failed') {
                const entryId = row.dataset.entryId;
                const contextRow = document.querySelector('.lr-context-row[data-entry-id="' + entryId + '"]');
                if (contextRow) {
                    contextRow.classList.add('error');
                }
            }
        }
    });

    // Handle AJAX refresh rendering (when auto-refresh is enabled)
    document.addEventListener('lr:refresh', function(e) {
        const data = e.detail;
        if (!data.logs) return;

        // For now, just reload the page on refresh
        // Future: implement proper client-side row rendering
        window.location.reload();
    });

    // Selection state
    let selectedIds = new Set();

    // Update selected count when selection changes
    document.addEventListener('lr:selectionChanged', function(e) {
        selectedIds = new Set(e.detail.selectedIds);
        const countSpan = document.getElementById('lr-selected-count');
        if (countSpan) {
            countSpan.textContent = selectedIds.size;
        }
    });

    // Delete button - handles selected items only
    const deleteBtn = document.getElementById('lr-delete-btn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const ids = Array.from(selectedIds);

            if (ids.length === 0) return;

            if (!confirm('{{ "Are you sure you want to delete {count} log(s)?"|t("sms-manager")|e("js") }}'.replace('{count}', ids.length))) {
                return;
            }

            Craft.sendActionRequest('POST', 'sms-manager/logs/bulk-delete', {
                data: { logIds: ids }
            })
            .then(response => {
                if (response.data.success) {
                    Craft.cp.displayNotice('{{ "Logs deleted successfully."|t("sms-manager")|e("js") }}');
                    window.location.reload();
                } else {
                    Craft.cp.displayError(response.data.message || '{{ "Failed to delete logs."|t("sms-manager")|e("js") }}');
                }
            })
            .catch(error => {
                Craft.cp.displayError('{{ "Failed to delete logs."|t("sms-manager")|e("js") }}');
            });
        });
    }

    // Individual row delete handler
    document.querySelectorAll('[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const id = this.dataset.id;
            if (!id) return;

            if (!confirm('{{ "Are you sure you want to delete this log?"|t("sms-manager")|e("js") }}')) {
                return;
            }

            Craft.sendActionRequest('POST', 'sms-manager/logs/bulk-delete', {
                data: { logIds: [id] }
            })
            .then(response => {
                if (response.data.success) {
                    Craft.cp.displayNotice('{{ "Log deleted successfully."|t("sms-manager")|e("js") }}');
                    // Remove the row from the table
                    const row = this.closest('tr');
                    const contextRow = document.querySelector('.lr-context-row[data-entry-id="' + row.dataset.entryId + '"]');
                    if (row) row.remove();
                    if (contextRow) contextRow.remove();
                } else {
                    Craft.cp.displayError(response.data.message || '{{ "Failed to delete log."|t("sms-manager")|e("js") }}');
                }
            })
            .catch(error => {
                Craft.cp.displayError('{{ "Failed to delete log."|t("sms-manager")|e("js") }}');
            });
        });
    });
    </script>
{% endblock %}
